///
///	item 134488 & resurgence
///
///

var itemsStats = {
	140803:{ilvl:875,int:1634},
	140793:{ilvl:870,mastery:1055},
	142507:{ilvl:865,int:1489,passive:1036},
	139076:{ilvl:865,int:1489,passive:1036},
	134336:{ilvl:865,int:1489,passive:1036},
	134204:{ilvl:865,int:1489,passive:1036},
	139114:{ilvl:865,int:1489,passive:1036},
	121311:{ilvl:865,int:1489,passive:1036},
	136750:{ilvl:865,int:1489,passive:1036},
	134292:{ilvl:865,int:1489,passive:1036},
	147276:{ilvl:865,int:1489,passive:1036},
	134160:{ilvl:865,int:1489,passive:1036},
	134380:{ilvl:865,int:1489,passive:1036},
	134248:{ilvl:865,int:1489,passive:1036},
	145231:{ilvl:865,int:1489,passive:1036},
	145230:{ilvl:865,int:1489,passive:1036},
	144258:{ilvl:940,int:2994,crit:456,mastery:456,haste:456},
	134526:{ilvl:825,crit:1062,mastery:797},
	141482:{ilvl:860,crit:847,mastery:847,vers:847,haste:847},
	137051:{ilvl:940,crit:2404,haste:1335},
	128911:{ilvl:825,int:6339,crit:271,mastery:260},
	128934:{ilvl:825,int:606,crit:356,mastery:342},
	132466:{ilvl:940,int:3150,crit:658,mastery:685,haste:1234},
	132452:{ilvl:940,crit:2671,haste:1818},
	
	142428:{ilvl:855,vers:1404,mastery:829,},
	142412:{ilvl:855,int:803,crit:544,vers:241,},
	142540:{ilvl:855,int:803,haste:325,vers:460,},
	142521:{ilvl:855,int:803,haste:510,mastery:275,},
	142432:{ilvl:855,int:1427,haste:579,vers:818,},
	142410:{ilvl:855,int:1427,crit:579,haste:818,},
	142431:{ilvl:855,int:1427,haste:579,vers:818,},
	142433:{ilvl:855,int:1427,haste:459,mastery:938,},
	142423:{ilvl:855,int:803,haste:325,mastery:460,},
	142419:{ilvl:855,int:803,crit:527,vers:258,},
	142415:{ilvl:855,int:803,vers:309,mastery:477,},
	142427:{ilvl:855,int:803,haste:510,vers:275,},
	142435:{ilvl:855,int:1070,crit:658,mastery:389,},
	142434:{ilvl:855,int:1070,crit:434,haste:613,},
	142430:{ilvl:855,int:1070,crit:411,mastery:635,},
	142429:{ilvl:855,int:1070,crit:680,vers:366,},
	142411:{ilvl:855,int:1070,haste:299,mastery:748,},
	142420:{ilvl:855,int:1070,crit:680,vers:366,},
	142416:{ilvl:855,int:1070,haste:613,mastery:434,},
	142424:{ilvl:855,int:1070,haste:411,mastery:635,},
	142421:{ilvl:855,int:1427,crit:968,haste:428,},
	142413:{ilvl:855,int:1427,crit:968,haste:428,},
	142425:{ilvl:855,int:1427,crit:459,mastery:938,},
	142418:{ilvl:855,int:1427,vers:518,mastery:878,},
	142422:{ilvl:855,int:1070,vers:658,mastery:389,},
	142417:{ilvl:855,int:1070,crit:680,haste:366,},
	142426:{ilvl:855,int:1070,crit:321,haste:725,},
	142414:{ilvl:855,int:1070,haste:725,mastery:321,},
	142520:{ilvl:855,crit:1021,haste:1212,},
	
	140870:{ilvl:875,int:1719,crit:1042,mastery:462,},
	138357:{ilvl:875,haste:1075,mastery:430,},
	138314:{ilvl:875,int:1719,haste:978,vers:527,},
	138330:{ilvl:875,int:1719,crit:914,mastery:591,},
	140866:{ilvl:875,int:1719,vers:849,mastery:656,},
	138312:{ilvl:875,int:1719,haste:1042,mastery:462,},
	138331:{ilvl:875,int:1719,crit:1042,vers:462,},
	140851:{ilvl:870,int:1641,crit:865,haste:612,},
	140903:{ilvl:870,int:1641,haste:897,vers:580,},
	140881:{ilvl:875,int:1719,crit:914,mastery:591,},
	138342:{ilvl:875,haste:623,mastery:881,},
	138332:{ilvl:875,crit:559,mastery:946,},
	138355:{ilvl:875,vers:527,mastery:978,},
	138378:{ilvl:875,int:1719,crit:527,haste:978,},
	138356:{ilvl:875,int:1719,crit:462,haste:1042,},
	140901:{ilvl:870,int:1641,haste:485,mastery:991,},
	138313:{ilvl:875,int:1719,crit:527,mastery:978,},
	138343:{ilvl:875,int:1719,crit:527,haste:978,},
	140900:{ilvl:875,haste:1151,vers:1368,},
	140899:{ilvl:875,crit:1440,mastery:1080,},
	140894:{ilvl:870,vers:908,mastery:1537,},
	140898:{ilvl:870,crit:768,haste:1677,},
	140853:{ilvl:870,int:1231,crit:744,mastery:364,},
	138347:{ilvl:875,crit:443,vers:685,},
	138363:{ilvl:875,vers:492,mastery:636,},
	140883:{ilvl:875,int:1289,crit:733,mastery:394,},
	138361:{ilvl:875,crit:346,haste:782,},
	138380:{ilvl:875,int:1289,haste:346,vers:782,},
	138323:{ilvl:875,int:1289,vers:443,mastery:685,},
	138362:{ilvl:875,int:1289,haste:443,vers:685,},
	140872:{ilvl:870,int:1231,crit:673,mastery:435,},
	138337:{ilvl:875,int:1289,vers:419,mastery:709,},
	138338:{ilvl:875,crit:758,haste:371,},
	138348:{ilvl:875,int:1289,haste:636,vers:492,},
	138336:{ilvl:875,int:1289,haste:733,mastery:394,},
	138321:{ilvl:875,int:1289,haste:782,vers:346,},
	138322:{ilvl:875,int:1289,haste:733,mastery:394,},
	140911:{ilvl:875,int:1289,crit:443,vers:685,},
	140864:{ilvl:875,int:1289,crit:492,mastery:636,},
	140917:{ilvl:880,int:1351,haste:328,mastery:822,},
	140855:{ilvl:875,int:967,crit:459,vers:386,},
	138375:{ilvl:875,int:967,crit:550,mastery:296,},
	138370:{ilvl:875,int:967,vers:550,mastery:296,},
	138373:{ilvl:875,int:967,haste:314,vers:532,},
	138366:{ilvl:875,int:967,haste:242,vers:604,},
	138369:{ilvl:875,int:967,haste:604,mastery:242,},
	138365:{ilvl:875,int:967,crit:513,mastery:332,},
	138367:{ilvl:875,int:967,crit:550,haste:296,},
	138368:{ilvl:875,int:967,vers:259,mastery:586,},
	138372:{ilvl:875,int:967,haste:314,mastery:532,},
	140910:{ilvl:875,int:967,haste:278,mastery:568,},
	138371:{ilvl:875,int:967,vers:568,mastery:278,},
	140909:{ilvl:875,int:967,haste:604,vers:242,},
	138374:{ilvl:875,int:967,haste:278,vers:568,},
	138364:{ilvl:875,int:967,vers:278,mastery:568,},
	138351:{ilvl:875,crit:1042,vers:462,},
	140877:{ilvl:875,int:1719,haste:623,vers:881,},
	138350:{ilvl:875,int:1719,crit:591,mastery:914,},
	140913:{ilvl:880,int:1801,haste:997,mastery:536,},
	138349:{ilvl:875,crit:430,haste:1075,},
	140865:{ilvl:870,int:1641,crit:644,haste:833,},
	138325:{ilvl:875,int:1719,haste:1075,mastery:430,},
	138339:{ilvl:875,haste:1075,vers:430,},
	138326:{ilvl:875,haste:623,mastery:881,},
	138376:{ilvl:875,int:1719,crit:978,vers:527,},
	138346:{ilvl:875,int:1719,crit:1042,mastery:462,},
	138324:{ilvl:875,int:1719,vers:462,mastery:1042,},
	138318:{ilvl:875,int:1719,vers:559,mastery:946,},
	140848:{ilvl:870,int:1641,haste:1023,mastery:454,},
	138319:{ilvl:875,int:1719,crit:914,haste:591,},
	138320:{ilvl:875,int:1719,crit:559,mastery:946,},
	140875:{ilvl:870,int:1641,haste:516,mastery:960,},
	140874:{ilvl:875,int:967,crit:568,mastery:278,},
	140878:{ilvl:875,int:967,crit:568,mastery:278,},
	140893:{ilvl:875,int:967,crit:314,haste:532,},
	140876:{ilvl:870,int:923,vers:487,mastery:344,},
	140886:{ilvl:875,int:967,haste:586,vers:259,},
	140889:{ilvl:875,int:967,crit:604,mastery:242,},
	140850:{ilvl:875,int:967,crit:314,mastery:532,},
	140902:{ilvl:870,int:923,vers:344,mastery:487,},
	140857:{ilvl:875,int:967,haste:550,mastery:296,},
	140869:{ilvl:870,int:1231,haste:720,mastery:387,},
	140863:{ilvl:870,int:1231,haste:411,mastery:696,},
	138327:{ilvl:875,int:1289,crit:758,vers:371,},
	138309:{ilvl:875,int:1289,crit:467,vers:661,},
	140905:{ilvl:875,int:1289,crit:467,mastery:661,},
	138328:{ilvl:875,int:1289,haste:443,vers:685,},
	138310:{ilvl:875,int:1289,crit:782,vers:346,},
	140888:{ilvl:870,int:1231,haste:387,mastery:720,},
	138377:{ilvl:875,int:1289,haste:782,mastery:346,},
	138353:{ilvl:875,int:1289,vers:394,mastery:733,},
	138354:{ilvl:875,crit:467,mastery:661,},
	138340:{ilvl:875,crit:685,haste:443,},
	140907:{ilvl:875,int:1289,crit:346,haste:782,},
	140879:{ilvl:870,int:1231,haste:506,mastery:601,},
	138329:{ilvl:875,haste:806,vers:322,},
	138341:{ilvl:875,int:1289,crit:492,vers:636,},
	138352:{ilvl:875,vers:709,mastery:419,},
	138311:{ilvl:875,int:1289,crit:782,mastery:346,},
	140880:{ilvl:870,int:1231,crit:459,mastery:648,},
	140887:{ilvl:875,int:1289,haste:636,mastery:492,},
	140912:{ilvl:875,int:1289,crit:733,vers:394,},
	140919:{ilvl:880,int:1351,crit:501,mastery:649,},
	140892:{ilvl:875,int:1289,haste:346,vers:782,},
	140890:{ilvl:875,int:1289,crit:515,vers:612,},
	140858:{ilvl:870,int:1231,crit:696,haste:411,},
	140868:{ilvl:875,int:1289,haste:661,mastery:467,},
	140859:{ilvl:875,int:1289,haste:733,vers:394,},
	140849:{ilvl:870,int:1231,haste:364,vers:744,},
	138379:{ilvl:875,int:1719,vers:591,mastery:914,},
	140908:{ilvl:875,int:1719,haste:656,vers:849,},
	140882:{ilvl:870,int:1641,haste:454,mastery:1023,},
	140871:{ilvl:870,int:1641,crit:454,haste:1023,},
	138359:{ilvl:875,int:1719,crit:978,vers:527,},
	138360:{ilvl:875,crit:623,haste:881,},
	138358:{ilvl:875,crit:914,haste:591,},
	140862:{ilvl:870,int:1641,haste:929,mastery:548,},
	138317:{ilvl:875,int:1719,crit:849,haste:656,},
	138333:{ilvl:875,int:1719,crit:494,haste:1010,},
	138315:{ilvl:875,int:1719,crit:978,haste:527,},
	138334:{ilvl:875,int:1719,crit:462,mastery:1042,},
	140852:{ilvl:875,int:1719,haste:688,mastery:817,},
	138344:{ilvl:875,crit:946,mastery:559,},
	138316:{ilvl:875,int:1719,haste:946,vers:559,},
	138345:{ilvl:875,int:1719,vers:623,mastery:881,},
	138335:{ilvl:875,crit:1042,vers:462,},
	140891:{ilvl:875,int:1289,haste:782,mastery:346,},
	140867:{ilvl:875,int:1289,vers:443,mastery:685,},
	140904:{ilvl:870,int:1231,crit:387,vers:720,},
	140885:{ilvl:875,int:1289,crit:419,vers:709,},
	140860:{ilvl:870,int:1231,haste:744,vers:364,},
	140854:{ilvl:870,int:1231,haste:506,mastery:601,},
	140861:{ilvl:875,int:1289,crit:492,mastery:636,},
	140914:{ilvl:880,int:1351,crit:772,mastery:378,},
	140884:{ilvl:870,int:1231,crit:673,haste:435,},
	140873:{ilvl:875,int:1289,crit:515,haste:612,},
	140895:{ilvl:875,crit:1728,mastery:792,},
	140896:{ilvl:875,haste:1512,vers:1008,},
	140906:{ilvl:875,crit:864,vers:1656,},
	140897:{ilvl:880,haste:742,mastery:1856,},
	140800:{ilvl:875,haste:1075,},
	140804:{ilvl:875,int:1634,},
	140795:{ilvl:875,haste:1075,},
	140798:{ilvl:875,crit:1075,},
	140793:{ilvl:870,mastery:1055,},
	140807:{ilvl:880,mastery:1095,},
	140808:{ilvl:880,haste:1095,},
	140792:{ilvl:870,int:1560,},
	140791:{ilvl:870,crit:1055,},
	140809:{ilvl:880,int:1712,},
	140805:{ilvl:875,int:1634,},
	140801:{ilvl:875,mastery:1075,},
	144406:{ilvl:870,int:1231,crit:340,mastery:767,},
};


var baseMana = 1100000 / 5;
var spellManaCost = {
	77472: 9 / 100 * baseMana,	//hw
	1064: 25 / 100 * baseMana,	//ch
	61295: 8 / 100 * baseMana,	//riptide
	73685: 5 / 100 * baseMana,	//ul
	5394: 11 / 100 * baseMana,	//hst
	157153: 8.6 / 100 * baseMana,	//cbt
	8004: 20 / 100 * baseMana,	//surge
	73920: 21.6 / 100 * baseMana,	//hr
	79206: 14.1 / 100 * baseMana,	//Spiritwalker's Grace
	198838: 11 / 100 * baseMana,	//est
	98008: 11 / 100 * baseMana,	//slt
	108280: 5.6 / 100 * baseMana,	//htt
	188838: 15 / 100 * baseMana,	//Flame Shock
	51505: 6 / 100 * baseMana,	//Lava Burst
	192058: 10 / 100 * baseMana,	//Lightning Surge Totem	
	207399: 11 / 100 * baseMana,	//apt
	197995: 20 / 100 * baseMana,	//wellspring
	2825: 21.5 / 100 * baseMana,	//bl
	32182: 21.5 / 100 * baseMana,	//heroism
};

var OverallBlacklist = {
	98021: true,	//slt
	208981: true,	//roots
	198838: true,	//est
	235967: true,	//velens itself
	206985: true, 	//guldan absorb
	143924: true, 	//leech
	225723: true,	//cake
	206838: true,	//trilliax
	207472: true,	//prydaz
	242621: true,	//tos(fa) trink
	242623: true,	//tos(kj) trink
};

var spellScaleInt = {
	1064: true,	//ch
	73921: true,	//hr
	77472: true,	//hw
	61295: true,	//riptide
	207778: true,	//GotQ
	255227: true,	//GotQ
	52042: true,	//hst
	73685: true,	//ul
	208899: true,	//qd
	8004: true,	//surge
	197997: true,	//wellspring
	228401: true,	//Mark of the Ancient Priestess
	209069: true,	//tidal
	114942: true,	//htt
};
var spellScaleMastery = {
	1064: true,	//ch
	73921: true,	//hr
	77472: true,	//hw
	61295: true,	//riptide
	207778: true,	//GotQ
	255227: true,	//GotQ
	52042: true,	//hst
	208899: true,	//qd
	8004: true,	//surge
	197997: true,	//wellspring
	//228401: true,	//Mark of the Ancient Priestess
	209069: true,	//tidal
	114942: true,	//htt
	73685: true,	//ul [fixed in 7.2.5]
};
var spellNotScaleHaste = {
	208899: true,	//qd
	209069: true,	//tidal
	98021: true,	//slt
	208981: true,	//roots
	242622: true,	//kj trink
	242619: true,	//tos(fa) trink
}
var spellAffectedByHaste = {	//not tick events, but still haste scaling
	73921: true,	//hr
	114942: true,	//htt
};

var spellScaleVers = {
	1064: true,	//ch
	73921: true,	//hr
	77472: true,	//hw
	61295: true,	//riptide
	207778: true,	//GotQ
	255227: true,	//GotQ
	52042: true,	//hst
	208899: true,	//qd
	8004: true,	//surge
	197997: true,	//wellspring
	228401: true,	//Mark of the Ancient Priestess
	209069: true,	//tidal
	114942: true,	//htt
	73685: true,	//ul
	242327: true,	//tos(di) trink
	242622: true,	//tos(kj) trink
	242623: true,	//tos(kj) trink
	242474: true,	//tos(sea) trink
	242619: true,	//tos(fa) trink
	242621: true,	//tos(fa) trink
};


var delayedSpells = [
	["buffCBT", 157503, {
	157503: true,	//cbt
	52042: true,	//hst
	209069: true,	//tidal
	114942: true,	//htt
	98021: true,	//slt
	206985: true, 	//guldan absorb
	143924: true, 	//leech
	235967: true,	//velens
	201633: true,	//est
}],	//cbt
	["buffAG", 114911, {
	114911: true,	//ag
	52042: true,	//hst
	209069: true,	//tidal
	114942: true,	//htt
	98021: true,	//slt
	206985: true, 	//guldan absorb
	143924: true, 	//leech
	235967: true,	//velens
	201633: true,	//est
}],	//ag
	["buffASC", 114083, {
	114083: true,	//asc
	114911: true,	//ag
	157503: true,	//cbt
	52042: true,	//hst
	209069: true,	//tidal
	114942: true,	//htt
	98021: true,	//slt
	206985: true, 	//guldan absorb
	143924: true, 	//leech
	235967: true,	//velens
	201633: true,	//est
}],	//asc
];

var cooldownsTrackingIDs = {
	108281: true,
	235966: true,
	114052: true,
	29166: true,
};
var cooldownsTrackingIDsbyCast = {
	157153: 15500,
};

var ignoredSpellsForCDTracking = {
	198839: true,
	201633: true,
	5672: true,
};

var healingFromMana = {
	1064: 1,	//ch
	73921: 1,	//hr
	157503: 0.75,	//cbt
	77472: 1,	//hw
	61295: 1,	//riptide
	114911: 0.75,	//ag
	//52042: 1,	//hst
	//208899: 1,	//qd
	73685: 1,	//ul
	235967: 0.75,	//velens
	114083: 0.75,	//asc
	8004: 1,	//surge
	197997: 1,	//wellspring
};

var vantusRunes = {
	192776: 'guldan',
	192768: 'anomaly',
	192775: 'elisande',
	192772: 'telarn',
	192773: 'krosus',
	192767: 'scorp',
	192770: 'aluriel',
	192774: 'etraeus',
	192771: 'tich',
	192769: 'trillax',
	
	237821: 'goroth',
	237828: 'di',
	237824: 'harj',
	237826: 'saj',
	237822: 'sotm',
	237827: 'dh',
	237823: 'mov',
	237820: 'fa',
	237825: 'kj',
};

var statsBuffs = {
	vers: {
		240670: 600,	//Stat Buff: Feral
	},
	crit: {
		240671: 800,	//Stat Buff: Fire
		190909: 1000, 	//Mark of the Claw
		224151: 3000,	//Traitor's Oath [suramar 5ppl set]
	},
	haste: {
		240673: 800,	//Stat Buff: spriest
		224347: 400,	//Flask of the Solemn Night
		214128: 6008,	//Chrono Shard
		190909: 1000, 	//Mark of the Claw
	},
	haste_mod: {
		80353: 1.3,	//BL
		2825: 1.3,	//BL
		32182: 1.3,	//BL
		160452: 1.3,	//BL
		90355: 1.3,	//BL
		146555: 1.25,	//BL
		230935: 1.25,	//BL
		208052: 1.25,	//Sephuz
		26297: 1.15,	//Troll racial
		202842: 1.1,	//Innervate moonkin
	},
	mastery: {
		240672: 600,	//Stat Buff: Rouge
		215198: 430,	//Thrumming Gossamer
	},
	int: {
		33697: 2137,	//orc racial
	},
};

var diffIdToName = {
	3: 'Normal',
	4: 'Heroic',
	5: 'Mythic',
	10: '5ppl keystone',
};

var classes = {
	'Priest': true,
	'Warlock': true,
	'Druid': true,
	'Hunter': true,
	'DemonHunter': true,
	'Shaman': true,
	'Monk': true,
	'Mage': true,
	'DeathKnight': true,
	'Paladin': true,
	'Warrior': true,
	'Rogue': true,
};

var qualityColors = {
	10: "e45a5a",
	2: "1eff00",
	3: "0070dd",
	4: "a335ee",
	5: "ff8000",
	6: "e5cc80",
};

var itemsBonusToStats = {
	605: 'mastery',
	603: 'crit',
	607: 'vers',
	604: 'haste',
};

var jewelSlots = {
	10: true,
	11: true,
	1: true,
};

var gemToStat = {
	130222: ["mastery",150],
	130220: ["haste",150],
	130219: ["crit",150],
	130221: ["vers",150],
	130248: ["int",200],
	151584: ["mastery",200],
	151583: ["haste",200],
	151580: ["crit",200],
	151585: ["vers",200],
};
var enchToStat = {
	5436: ["int",200],
	5469: ["int",200],
	5890: ["mastery",600],
	5429: ["mastery",150],
	5427: ["crit",150],
	5428: ["haste",150],
	5430: ["vers",150],
};

var WCL_API_KEY = "c715943c916421282ae9451912918422";
var STATS_GRAPH_STEP = 15;

var actors = [];		// Used for filter events only for char & his summons
var actorsData = [];		// All units data
var fightsData = [];		// All fights data
var healingData = [];		// Spells healing data
var currFightData = [];		// Selected fight info
var pV = {};			// "Garbage" variables, used for parsing
var rV = {			// Result Variables
	talents: [],
	traits: [],
	resurgence: [],
	potions: [],
	buffs: {
		vers: [],
		crit: [],
		haste: [],
		haste_mod: [],
		mastery: [],
		int: [],	
	},
	healFromMana: 0,
	manaUsage: 0,
	manaGain: 0,
};
var cV = {			// Char Variables
	traitInfo: [],
	gearInfo: [],
	talentInfo: [],
	spellInfo: [],
};
var healPerStat = {		// Healing per stat data
	int: {amount:0,total:0,avg:0,avgCount:0},
	crit: {amount:0,total:0,avg:0,avgCount:0},
	haste: {amount:0,total:0,avg:0,avgCount:0},
	mastery: {amount:0,total:0,avg:0,avgCount:0,all:0},
	vers: {amount:0,total:0,avg:0,avgCount:0},
};
var cooldownsTracking = [];	// Cooldowns data
var sltTracking = [];		// Spirit Link data
var buffStatus = [];		// Buffs

var reportFightCode;


function GetTraitRank(traitID)
{
	if(cV.traitInfo[traitID])
		return cV.traitInfo[traitID].rank;
	else
		return 0;
}

function ScaleStat(stat,fromIlvl,toIlvl,isLinear)
{
	//	linear == 1 for int, linear == nil for secondaries, linear == 2 for jewel slots
	var scalingFrom = (fromIlvl <= 800 || isLinear == 1) ? 1 : (isLinear == 2 ? Math.pow(0.996754034,fromIlvl - 800) : Math.pow(0.994435486,fromIlvl - 800));
	var scalingTo = (toIlvl <= 800 || isLinear == 1) ? 1 : (isLinear == 2 ? Math.pow(0.996754034,toIlvl - 800) : Math.pow(0.994435486,toIlvl - 800));
	
	stat = stat / scalingFrom;
	var newValue = stat * Math.pow(1.00936,toIlvl - fromIlvl);
	newValue *= scalingTo;
	
	return newValue;
}

function MsToFormattedTime(ms,calcFromPull)
{
	if(calcFromPull) ms -= currFightData.start_time;
	var min = Math.floor(ms / 60000);
	var sec = Math.floor( (ms - min * 60000) / 1000 );
	
	return (min < 10 ? "0" : "")+min+":"+(sec < 10 ? "0" : "")+sec;
	
}

function NumberToFormattedNumber(num,decimals,decimals_m,decimals_k)
{
	if(num > 1000000000){
		decimals = decimals || 2;
		return (num / 1000000000).toFixed(decimals)+"M";
	} else if (num > 1000000){
		decimals = decimals || 0;
		if(decimals_m) decimals = decimals_m;
		return (num / 1000000).toFixed(decimals)+"m";
	} else if (num > 1000){
		decimals = decimals || 0;
		if(decimals_k) decimals = decimals_k;
		return (num / 1000).toFixed(decimals)+"k";
	} else {
		return Math.floor(num);
	}	
}

function error_msg(msg) {
	$("#main").html("<div class=\"panel\"><div class=\"col-full\"><div class=\"box\">"+msg+"</div></div></div>");

}

function GetDelayedSpellsFeed(spellID){
	var result = {};
	for (var j = 0, j_len = delayedSpells.length; j < j_len; j++) {
		var CDdata = pV[ delayedSpells[j][0] ];
		if(CDdata.spellsfeed[spellID] && healingData[ delayedSpells[j][1] ] && healingData[ delayedSpells[j][1] ][0] > 0){
			result.push([delayedSpells[j][1],CDdata.spellsfeed[spellID] / CDdata.feed * healingData[ delayedSpells[j][1] ][0]]);
		}
	}
	return result;
}

var NETHERLIGHT;

var ITEMS = [
	{	//Velens
		init: function() {
			rV.velensAmount = 0;
		},
		parse: [
			"heal", function(event,spellID,amount){
				if(pV.velensEnabled && !OverallBlacklist[spellID]){
					rV.velensAmount += amount * (1 - (1 / 1.15));
				} else if(spellID == 235967){
					rV.velensAmount += amount;
				}
			},
			"applybuff", function(event,spellID){
				if(spellID == 235966) pV.velensEnabled = true;
			},
			"removebuff", function(event,spellID){
				if(spellID == 235966) pV.velensEnabled = false;
			},
		],
		obj: {
			type: "item",
			name: "Velen's Future Sight",
			quality: 5,
			id: 144258,
			gear: "velensAmount",
		},
	},
	{	//Tidecallers
		init: function() {
			rV.tidecallersAmount = 0;
			rV.tidecallersPredictionAmount = 0;
			pV.tidecallersHST = [];
			pV.tidecallersQD = {};
		},
		parse: [
			"heal", function(event,spellID,amount){
				if(spellID == 114942){ //htt
					if(pV.tidecallersLast && event.timestamp >= pV.tidecallersLast) rV.tidecallersAmount += amount;
				} else if (spellID == 52042) { //hst
					for (var j = 0, j_len = pV.tidecallersHST.length; j < j_len; j++) {
						if(event.timestamp >= pV.tidecallersHST[j][0] && event.timestamp <= pV.tidecallersHST[j][1]){
							rV.tidecallersAmount += amount;
						}
					}
				} else if (spellID == 208899) { //qd
					if(pV.tidecallersQD[ event.targetID ] && event.timestamp <= pV.tidecallersQD[ event.targetID ]){
						rV.tidecallersAmount += amount;
					}
				}
			},
			"cast", function(event,spellID){
				if(spellID == 108280) { //htt
					pV.tidecallersLast = event.timestamp + 10000;
				} else if (spellID == 5394) { //hst
					pV.tidecallersHST.push([event.timestamp + 15000,event.timestamp + 18200]);
				} 
			},
			"applybuff", function(event,spellID){
				if(spellID == 208899) {
					for (var j = 0, j_len = pV.tidecallersHST.length; j < j_len; j++) {
						if(event.timestamp >= pV.tidecallersHST[j][0] && event.timestamp <= pV.tidecallersHST[j][1]){
							pV.tidecallersQD[ event.targetID ] = event.timestamp + 6200;
						}
					}
				}
			},
		],
		afterParse: function() {
			if(healingData[52042]) {
				//rV.tidecallersAmount += healingData[52042][0] * 0.16666;
				rV.tidecallersPredictionAmount += healingData[52042][0] * 0.2;
			}
			if(healingData[208899]) {
				//rV.tidecallersAmount += healingData[208899][0] * 0.16666;
				rV.tidecallersPredictionAmount += healingData[208899][0] * 0.2;
			}
			if(healingData[114942]) rV.tidecallersPredictionAmount += healingData[114942][0] * 0.2;
		},
		obj: {
			type: "item",
			name: "Praetorian's Tidecallers",
			quality: 5,
			id: 137058,
			prediction: "tidecallersPredictionAmount",
			gear: "tidecallersAmount",
		},
	},
	{	//jonat
		init: function() {
			rV.jonatAmount = 0;
			pV.jonatCount = 0;
			
			rV.jonatPredictionAmount = 0;
			pV.jonatLast = 0;
			pV.jonatPredictionLast = 0;
			pV.jonatPredictionCount = 0;
			pV.jonatPredictionCountNow = 0;
			
			pV.jonatAmountCBT = 0;
			pV.jonatAmountAG = 0;
			pV.jonatAmountASC = 0;
			
			pV.jonatAvgBuff = 0;
			pV.jonatAvgBuffCount = 0;
		},
		parse: [
			"heal", function(event,spellID,amount){
				if(spellID == 1064){ //ch
					if(event["timestamp"] < pV.jonatLast){
						rV.jonatAmount += amount * (1 - 1 / (1 + 0.10 * pV.jonatCount));
						
						var amWOh = (amount + (event.overheal || 0)) * (1 - 1 / (1 + 0.10 * pV.jonatCount));
						if(pV.buffAGActive) pV.jonatAmountAG += amWOh;
						if(pV.buffCBTActive) pV.jonatAmountCBT += amWOh;
						if(pV.buffASCActive) pV.jonatAmountASC += amWOh;
					}
					
					if(event["timestamp"] < pV.jonatPredictionLast){
						rV.jonatPredictionAmount += amount * (0.10 * pV.jonatPredictionCountNow);
					}
				}
			},
			"cast", function(event,spellID){
				if(spellID == 1064) { //ch
					pV.jonatPredictionCountNow = pV.jonatPredictionCount;
					pV.jonatPredictionLast = event["timestamp"] + 1000;
					pV.jonatPredictionCount = 0;
					
					pV.jonatAvgBuffCount++;
					pV.jonatAvgBuff+=pV.jonatPredictionCountNow;
				} else if(spellID == 77472 || spellID == 8004) { //hw & surge
					pV.jonatPredictionCount = Math.min(pV.jonatPredictionCount+1,5);
				}
			},
			"applybuff", function(event,spellID){
				if(spellID == 210607) pV.jonatCount = 1;
			},
			"applybuffstack", function(event,spellID){
				if(spellID == 210607) pV.jonatCount = event.stack;
			},
			"removebuff", function(event,spellID){
				if(spellID == 210607) pV.jonatLast = event.timestamp + 500;
			},
			"removebuffstack", function(event,spellID){
				if(spellID == 210607) pV.jonatLast = event.timestamp + 500;
			},
		],
		afterParse: function() {
			if(pV.buffAG.mod) rV.jonatAmount += pV.jonatAmountAG * pV.buffAG.mod;
			if(pV.buffCBT.mod) rV.jonatAmount += pV.jonatAmountCBT * pV.buffCBT.mod;
			if(pV.buffASC.mod) rV.jonatAmount += pV.jonatAmountASC * pV.buffASC.mod;
			console.log(pV.jonatAmountCBT,pV.jonatAmountAG,pV.jonatAmountASC);
		},		
		obj: {
			type: "item",
			name: "Focuser of Jonat, the Elder",
			quality: 5,
			id: 137051,
			prediction: "jonatPredictionAmount",
			gear: "jonatAmount",
			gearAdditionalText: function() { 
				if(pV.jonatAvgBuffCount > 0)
					return "Avg buff: "+(pV.jonatAvgBuff / pV.jonatAvgBuffCount * 10).toFixed(0)+"%";
				else
					return "Avg buff: 0%";
			},
		},
	},
	{	//prydaz
		init: function() {
			rV.prydazAmount = 0;
			rV.prydazPredictionAmount = 0;
			pV.prydazNextReset = 0;
			pV.prydazCurrent = 0;
		},
		parse: [
			"damage", function(event,spellID){
				if(event.targetID == currFightData.actor && event.resourceActor == 2 && event.maxHitPoints){
					if(event.timestamp > pV.prydazNextReset) {
						pV.prydazCurrent = event.maxHitPoints * 0.25;
						while(pV.prydazNextReset < event.timestamp){
							pV.prydazNextReset += 30000;
						}
					}
					var prydaz = Math.min(pV.prydazCurrent,event.amount);
					rV.prydazPredictionAmount += prydaz;
					pV.prydazCurrent -= prydaz;
				}
				
			},
			"combantantInfo", function(event){
				pV.prydazNextReset = event.timestamp - 1;
			}
		],
		afterParse: function() {
			if(healingData[207472]) {
				rV.prydazAmount = healingData[207472][0];
			}
		},
		obj: {
			type: "item",
			name: "Prydaz, Xavaric's Magnum Opus",
			quality: 5,
			id: 132444,
			prediction: "prydazPredictionAmount",
			gear: "prydazAmount",
		},
	},
	{	//2t20
		init: function() {
			rV.t20_2p_PredictionAmount = 0;
			rV.t20_2p_Amount = 0;
			rV.t20_2p_Count = 0;
			pV.t20_2p_gearCount = 0;
			pV.t20_2p_last = 0;
			pV.t20_2p_curr = 0;
			pV.t20_2p_curr_targets = [];
			pV.t20_2p_pred_targets = [];
			pV.t20_2p_buffLast = 0;
		},
		parse: [
			"heal", function(event,spellID,amount){
				if(spellID == 61295){
					//prediction
					if(!event.tick){
						if(event.timestamp > pV.t20_2p_last){
							pV.t20_2p_last = event.timestamp + 60000;
							pV.t20_2p_curr = 3;	//~3 ppm on testing
						}
						if(pV.t20_2p_curr > 0){
							if(event.hitType == 1){
								rV.t20_2p_PredictionAmount += amount;
								
								pV.t20_4p_PredictionNext = event.timestamp + 15000;
							}
							pV.t20_2p_pred_targets[event.targetID] = event.timestamp + 18000;
							pV.t20_2p_curr--;
						}
					} else if(pV.t20_2p_pred_targets[event.targetID] && pV.t20_2p_pred_targets[event.targetID] <= event.timestamp && event.hitType == 1){
						rV.t20_2p_PredictionAmount += amount;
					}
					

					//real
					if(!event.tick){
						if(pV.t20_2p_buffActive || (event.timestamp <= pV.t20_2p_buffLast)){
							pV.t20_2p_curr_targets[event.targetID] = event.timestamp + 18000;
							rV.t20_2p_Count ++;
						} else {
							pV.t20_2p_curr_targets[event.targetID] = 0;
						}
					}
					if(pV.t20_2p_curr_targets[event.targetID] && pV.t20_2p_curr_targets[event.targetID] >= event.timestamp && event.hitType == 2){
						rV.t20_2p_Amount += pV.critAmount * Math.max(1 - (pV.critNow / 40000),0);
					}
				}
			},
			"removebuff", function(event,spellID){
				if(spellID == 246729) {
					pV.t20_2p_buffLast = event.timestamp + 500;
					pV.t20_2p_buffActive = false;
				}
			},	
			"applybuff", function(event,spellID){
				if(spellID == 246729) {
					pV.t20_2p_buffActive = true;
				}
			},				
			"gear", function(itemData,itemID){
				if(itemID == 147175 || itemID == 147176 || itemID == 147177 || itemID == 147178 || itemID == 147179 || itemID == 147180) pV.t20_2p_gearCount++;
			}
		],
		obj: {
			type: "spell",
			name: "T20 2 set Bonus",
			quality: 10,
			id: 242287,
			prediction: "t20_2p_PredictionAmount",
			predictionСondition: function() { return pV.t20_2p_gearCount < 2 },
			gear: "t20_2p_Amount",
			gearFunc: function() { return pV.t20_4p_gearCount >= 2 },
			gearAdditionalText: function() { return rV.t20_2p_Count+" times" },
			icon: "spell_nature_riptide.jpg",
		},
	},
	{	//4t20
		init: function() {
			rV.t20_4p_Amount = 0;
			rV.t20_4p_Count = 0;
			rV.t20_4p_PredictionAmount = 0;
			pV.t20_4p_gearCount = 0;
			pV.t20_4p_PredictionNext = 0;
			pV.t20_4p_buffLast = 0;
		},
		parse: [
			"heal", function(event,spellID,amount){
				if(spellID == 61295 && !event.tick && event.hitType == 2){
					pV.t20_4p_PredictionNext = event.timestamp + 15000;
				} else if (spellID == 73921 && pV.t20_4p_PredictionEnabled){
					rV.t20_4p_PredictionAmount += amount * 0.5;
				}
				
				if(spellID == 73921 && pV.t20_4p_Active){
					rV.t20_4p_Amount += amount * (1 - (1 / 1.5))
				}
			},
			"cast", function(event,spellID){
				if(spellID == 73920){
					pV.t20_4p_PredictionEnabled = false;
					if(event.timestamp <= pV.t20_4p_PredictionNext){
						pV.t20_4p_PredictionEnabled = true;
					}
					pV.t20_4p_PredictionNext = 0;
					
					pV.t20_4p_Active = false;
					if(event.timestamp <= pV.t20_4p_buffLast){
						pV.t20_4p_Active = true;
						rV.t20_4p_Count ++;
					}
				}
			},
			"removebuff", function(event,spellID){
				if(spellID == 246771) pV.t20_4p_buffLast = event.timestamp + 500;
			},
			"gear", function(itemData,itemID){
				if(itemID == 147175 || itemID == 147176 || itemID == 147177 || itemID == 147178 || itemID == 147179 || itemID == 147180) pV.t20_4p_gearCount++;
			}
		],
		obj: {
			type: "spell",
			name: "T20 4 set Bonus",
			quality: 10,
			id: 242288,
			prediction: "t20_4p_PredictionAmount",
			predictionСondition: function() { return pV.t20_2p_gearCount < 4 },
			gear: "t20_4p_Amount",
			gearFunc: function() { return pV.t20_4p_gearCount >= 4 },
			gearAdditionalText: function() { return rV.t20_4p_Count+" times" },
			icon: "spell_nature_giftofthewaterspirit.jpg",
		},
	},
	{	//paradox
		init: function() {
			rV.paradoxAmount = 0;
			rV.paradoxMana = 0;
		},
		parse: [
			"energize", function(event,spellID){
				if(spellID == 225772){
					rV.manaGain += 19800;
					rV.paradoxAmount += event.resourceChange + 19800;
					rV.manaUsage -= 19800;
					if(rV.manaUsageBySpell[77472]) rV.manaUsageBySpell[77472] -= 19800;
					
					for (var j = 0, j_len = cooldownsTracking.length; j < j_len; j++) {
						if(cooldownsTracking[j].opened){
							cooldownsTracking[j].mana -= 19800;
						}
					}
				}
			},
		],
		afterParse: function() {
			rV.paradoxMana = rV.paradoxAmount;
			rV.paradoxAmount = rV.paradoxMana / rV.manaUsage * rV.healFromMana;
		},
		obj: {
			type: "item",
			name: "Ephemeral Paradox",
			quality: 4,
			id: 140805,
			gear: "paradoxAmount",
			gearAdditionalText: function() { return "Mana gain: "+NumberToFormattedNumber(rV.paradoxMana,0,2); },
		},
	},
	{	//2t19
		init: function() {
			rV.t19_2p_Amount = 0;
			rV.t19_2p_Count = 0;
			pV.t19_2p_gearCount = 0;
			pV.t19_2p_twloss = 0;
		},
		parse: [
			"heal", function(event,spellID,amount){
				if((spellID == 77472 || spellID == 8004) && event.timestamp <= pV.t19_2p_twloss){
					rV.t19_2p_Amount += amount * 0.13044;
					rV.t19_2p_Count ++;		
				}
			},
			"removebuff", function(event,spellID){
				if(spellID == 53390) pV.t19_2p_twloss = event.timestamp + 500;
			},
			"removebuffstack", function(event,spellID){
				if(spellID == 53390) pV.t19_2p_twloss = event.timestamp + 500;
			},
			"gear", function(itemData,itemID){
				if(itemID == 138343 || itemID == 138341 || itemID == 138345 || itemID == 138346 || itemID == 138348 || itemID == 138372) pV.t19_2p_gearCount++;
			}
		],
		obj: {
			type: "spell",
			name: "T19 2 set Bonus",
			quality: 10,
			id: 211992,
			gear: "t19_2p_Amount",
			gearFunc: function() { return pV.t19_2p_gearCount >= 2 },
			gearAdditionalText: function() { return rV.t19_2p_Count+" times" },
			icon: "spell_shaman_tidalwaves.jpg",
		},
	},
	{	//uncertain
		init: function() {
			rV.uncertainAmount = 0;
			pV.uncertainActive = 0;
			rV.uncertainPredictionAmount = 0;
			pV.uncertainPredictionTime = 0;
		},
		parse: [
			"heal", function(event,spellID,amount){
				if(!OverallBlacklist[spellID]){
					if(pV.uncertainActive && (event.timestamp >= pV.uncertainTime)){
						rV.uncertainAmount += amount * (1 - 1 / 1.25);
					}
					if(event.timestamp < pV.uncertainPredictionTime){
						rV.uncertainPredictionAmount += amount * 0.25;
					}				
				}
			},
			"applybuff", function(event,spellID){
				if(spellID == 208416) {
					pV.uncertainActive = true;
					pV.uncertainTime = event.timestamp + 40000;
				}
			},			
			"removebuff", function(event,spellID){
				if(spellID == 208416) {
					pV.uncertainActive = false;
					pV.uncertainTime = 0;
					pV.uncertainPredictionTime = event.timestamp + 30000;
				}
			},			
		],
		obj: {
			type: "item",
			name: "Uncertain Reminder",
			quality: 5,
			id: 143732,
			prediction: "uncertainPredictionAmount",
			gear: "uncertainAmount",
		},
	},
	{	//boots
		init: function() {
			rV.bootsAmount = 0;
			rV.bootsPredictionAmount = 0;
			pV.bootsData = [];
			pV.bootsCast = 0;
		},
		parse: [
			"heal", function(event,spellID,amount){
				if(spellID == 73921){
					pV.bootsData[ event.targetID ] = true;
				} else if(pV.bootsData[ event.targetID ] && event.timestamp <= pV.bootsCast){
					rV.bootsPredictionAmount += amount * 0.1;
					rV.bootsAmount += amount * (1 - 1 / 1.1);
				}
			},
			"cast", function(event,spellID){
				if(spellID == 73920) {
					pV.bootsData = [];
					pV.bootsCast = event.timestamp + 10000;
				}
			},		
		],
		obj: {
			type: "item",
			name: "Elemental Rebalancers",
			quality: 5,
			id: 137036,
			prediction: "bootsPredictionAmount",
			gear: "bootsAmount",
		},
	},
	{	//nobundos
		init: function() {
			rV.nobundosAmount = 0;
			rV.nobundosMana = 0;
			rV.nobundosCount = 0;
			rV.nobundosPredictionAmount = 0;
			rV.nobundosPredictionMana = 0;
			rV.nobundosPredictionCount = 0;
			pV.nobundosLastCast = 0;
		},
		parse: [
			"cast", function(event,spellID){
				if(spellID == 8004) {
					if(pV.nobundosLast){
						rV.nobundosPredictionMana += 22000;
						rV.nobundosPredictionCount++;
					}
					pV.nobundosLast = false;
					
					pV.nobundosLastCast = event.timestamp + 500;
				} else if(spellID == 1064) {
					pV.nobundosLast = true;
				}
			},		
			"removebuff", function(event,spellID){
				if(spellID == 208764 && (event.timestamp <= pV.nobundosLastCast)){
					rV.nobundosMana += 22000;
					rV.nobundosCount++;
					rV.manaGain += 22000;
					rV.manaUsage -= 22000;
					if(rV.manaUsageBySpell[8004]) rV.manaUsageBySpell[8004] -= 22000;
				}			
			},
		],
		afterParse: function() {
			rV.nobundosAmount = rV.nobundosMana / rV.manaUsage * rV.healFromMana;
			rV.nobundosPredictionAmount = rV.nobundosPredictionMana / (rV.manaUsage - rV.nobundosPredictionMana) * rV.healFromMana ;
		},
		obj: {
			type: "item",
			name: "Nobundo's Redemption",
			quality: 5,
			id: 137104,
			prediction: "nobundosPredictionAmount",
			gear: "nobundosAmount",
			text: function() { return "(mana saved: "+NumberToFormattedNumber(rV.nobundosPredictionMana,0,2)+")"; },
			gearAdditionalText: function() { return "Mana gain: "+NumberToFormattedNumber(rV.nobundosMana,0,2); },
		},
	},
	{	//manaring
		init: function() {
			rV.manaringAmount = 0;
		},
		parse: [
			"heal", function(event,spellID,amount){
				if(pV.manaringActive){
					rV.manaringAmount += amount * (1 - 1 / 1.05);
				}
			},
			"applybuff", function(event,spellID){
				if(spellID == 228461) pV.manaringActive = true;
			},			
			"removebuff", function(event,spellID){
				if(spellID == 228461) pV.manaringActive = false;
			},		
		],
		obj: {
			type: "item",
			name: "Gnawed Thumb Ring",
			quality: 4,
			id: 134526,
			gear: "manaringAmount",
		},
	},
	{	//roots
		init: function() {
			rV.rootsAmount = 0;
		},
		afterParse: function() {
			if(healingData[208981]) {
				rV.rootsAmount = healingData[208981][0];
			}
		},
		obj: {
			type: "item",
			name: "Roots of Shaladrassil",
			quality: 5,
			id: 132466,
			gear: "rootsAmount",
		},
	},
	{	//cake
		init: function() {
			rV.cakeAmount = 0;
		},
		afterParse: function() {
			if(healingData[225723]) {
				rV.cakeAmount = healingData[225723][0];
			}
		},
		obj: {
			type: "item",
			name: "Perfectly Preserved Cake",
			quality: 4,
			id: 140793,
			gear: "cakeAmount",
		},
	},
	{	//etraeus
		init: function() {
			rV.etraeusAmount = 0;
		},
		parse: [
			"gear", function(itemData,itemID){
				if(itemID == 140803) {
					var etraeusBuffStat = ScaleStat(3892.9,875,itemData.itemLevel);
					statsBuffs.haste[225753] = etraeusBuffStat;
					statsBuffs.mastery[225752] = etraeusBuffStat;
					statsBuffs.crit[225749] = etraeusBuffStat;
				}
			}
		],
		afterParse: function() {
			if(rV.buffs.haste[225753]) rV.etraeusAmount += rV.buffs.haste[225753];
			if(rV.buffs.mastery[225752]) rV.etraeusAmount += rV.buffs.mastery[225752];
			if(rV.buffs.crit[225749]) rV.etraeusAmount += rV.buffs.crit[225749];
		},
		obj: {
			type: "item",
			name: "Etraeus' Celestial Map",
			quality: 4,
			id: 140803,
			gear: "etraeusAmount",
		},
	},
	{	//Dreadstone of Endless Shadows
		init: function() {
			rV.coentrinkAmount = 0;
		},
		parse: [
			"gear", function(itemData,itemID){
				if(itemID == 144480) {
					var buffStat = ScaleStat(3892.9,875,itemData.itemLevel);
					statsBuffs.haste[238501] = buffStat;
					statsBuffs.mastery[238500] = buffStat;
					statsBuffs.crit[238499] = buffStat;
				}
			}
		],
		afterParse: function() {
			if(rV.buffs.haste[238501]) rV.coentrinkAmount += rV.buffs.haste[238501];
			if(rV.buffs.mastery[238500]) rV.coentrinkAmount += rV.buffs.mastery[238500];
			if(rV.buffs.crit[238499]) rV.coentrinkAmount += rV.buffs.crit[238499];
		},
		obj: {
			type: "item",
			name: "Dreadstone of Endless Shadows",
			quality: 4,
			id: 144480,
			gear: "coentrinkAmount",
		},
	},	
	{	//darkmoon
		init: function() {
			rV.darkmoonAmount = 0;
			rV.darkmoonAmountMana = 0;
			pV.darkmoonManaNow = 0;
			pV.darkmoonBuffs = {
				191615: 770,
				191616: 1059,
				191617: 1349,
				191618: 1636,
				191619: 1924,
				191620: 2212,
				191621: 2501,
				191622: 3078,
			};
		},
		parse: [
			"cast", function(event,spellID){
 				if(spellManaCost[spellID] && !pV.innervate && (pV.darkmoonManaNow > 0)){
					rV.darkmoonAmountMana += pV.darkmoonManaNow;
					rV.manaGain += pV.darkmoonManaNow;
					rV.manaUsage -= pV.darkmoonManaNow;
					rV.manaUsageBySpell[pV.manaUsageLastSpell] -= pV.darkmoonManaNow;
				}
			},
			"applybuff", function(event,spellID){
				if(pV.darkmoonBuffs[spellID]) pV.darkmoonManaNow = pV.darkmoonBuffs[spellID];
			},
			"gear", function(itemData,itemID){
				if(itemID == 128710) {
					var updatedVals = {};
					Object.keys(pV.darkmoonBuffs).forEach(function (buffSpellID) {
						updatedVals[buffSpellID] = ScaleStat(pV.darkmoonBuffs[buffSpellID],900,itemData.itemLevel);
					});
					pV.darkmoonBuffs = updatedVals;
				}
			}
		],
		afterParse: function() {
			rV.darkmoonAmount = rV.darkmoonAmountMana / rV.manaUsage * rV.healFromMana;
		},
		obj: {
			type: "item",
			name: "Darkmoon Deck: Promises",
			quality: 4,
			id: 128710,
			gear: "darkmoonAmount",
			gearAdditionalText: function() { return "Mana gain: "+NumberToFormattedNumber(rV.darkmoonAmountMana,0,2); },
		},
	},
	{	//drape
		init: function() {
			rV.drapeAmount = 0;
		},
		parse: [
			"heal", function(event,spellID,amount){
 				if(event.hitType == 2){
					rV.drapeAmount += pV.critAmount * (0.05 / 1.05);
				}
			},
		],
		obj: {
			type: "item",
			name: "Drape of Shame",
			quality: 4,
			id: 142170,
			gear: "drapeAmount",
		},
	},
	{	//belt
		init: function() {
			rV.beltAmount = 0;
			rV.beltCount = 0;
			pV.beltRiptideCount = 0;
		},
		parse: [
			"heal", function(event,spellID,amount){
 				if(spellID == 61295 && !event.tick && event.resourceActor == 2 && event.hitPoints && event.maxHitPoints){
 					var targetHPbeforeHeal = Math.max(event.hitPoints - amount,0) / event.maxHitPoints;
					if(targetHPbeforeHeal <= .4) rV.beltCount++;
				}
			},
			"cast", function(event,spellID){
 				if(spellID == 61295) pV.beltRiptideCount++;
			},			
		],
		afterParse: function() {
			if(healingData[61295]) rV.beltAmount = healingData[61295][0] / pV.beltRiptideCount * rV.beltCount;
		},
		obj: {
			type: "item",
			name: "Intact Nazjatar Molting",
			quality: 5,
			id: 137085,
			gear: "beltAmount",
			gearAdditionalText: function() { return "Procs number: "+rV.beltCount; },
			prediction: "beltAmount",
			text: function() { return "(procs: "+rV.beltCount+")"; }, 
		},
	},
	{	//Amalgam
		init: function() {
			rV.amalgamAmount = 0;
			rV.amalgamMana = 0;
		},
		parse: [
			"energize", function(event,spellID){
				if(spellID == 215270){
					rV.manaGain += event.resourceChange;
					rV.amalgamMana += event.resourceChange;
				}
			},
		],
		afterParse: function() {
			rV.amalgamAmount = rV.amalgamMana / rV.manaUsage * rV.healFromMana;
		},
		obj: {
			type: "item",
			name: "Amalgam's Seventh Spine",
			quality: 4,
			id: 136714,
			gear: "amalgamAmount",
			gearAdditionalText: function() { return "Mana gain: "+NumberToFormattedNumber(rV.amalgamMana,0,2); },
		},
	},
	{	//kara trink
		init: function() {
			rV.karatrinkAmount = 0;
			rV.karatrinkMana = 0;
		},
		parse: [
			"energize", function(event,spellID){
				if(spellID == 230144){
					rV.manaGain += event.resourceChange;
					rV.karatrinkMana += event.resourceChange;
				}
			},
		],
		afterParse: function() {
			rV.karatrinkAmount = rV.karatrinkMana / rV.manaUsage * rV.healFromMana;
		},
		obj: {
			type: "item",
			name: "Fluctuating Energy",
			quality: 4,
			id: 142162,
			gear: "karatrinkAmount",
			gearAdditionalText: function() { return "Mana gain: "+NumberToFormattedNumber(rV.karatrinkMana,0,2); },
		},
	},
	{	//darkmoon crit
		init: function() {
			rV.darkmoonCritAmount = 0;
			pV.darkmoonCritBuffs = {
				191603: 637,
				191604: 718,
				191605: 797,
				191606: 877,
				191607: 956,
				191608: 1037,
				191609: 1116,
				191610: 1275,
			};
		},
		parse: [
			"gear", function(itemData,itemID){
				if(itemID == 128709) {
					Object.keys(pV.darkmoonCritBuffs).forEach(function (buffSpellID) {
						statsBuffs.crit[buffSpellID] = ScaleStat(pV.darkmoonCritBuffs[buffSpellID],812,itemData.itemLevel);
					});
				}
			}
		],
		afterParse: function() {
			Object.keys(pV.darkmoonCritBuffs).forEach(function (buffSpellID) {
				rV.darkmoonCritAmount += (rV.buffs.crit[buffSpellID] || 0);
			});
		},
		obj: {
			type: "item",
			name: "Darkmoon Deck: Hellfire",
			quality: 4,
			id: 128709,
			gear: "darkmoonCritAmount",
		},
	},
	{	//chest leggo
		init: function() {
			rV.firedeepAmount = 0;
			pV.firedeepLastAura = 0;
			pV.firedeepLastCast = 0;
			pV.firedeepTemp = 0;
			pV.firedeepHRCount = 0;
			pV.firedeepProcCount = 0;
		},
		parse: [
			"heal", function(event,spellID,amount){
				if(spellID == 114083 && pV.firedeepActive){
					rV.firedeepAmount += amount;
					pV.firedeepTemp += amount;
				}
			},
			"applybuff", function(event,spellID){
				if(spellID == 114052) {
					pV.firedeepLastAura = event.timestamp + 500;
					pV.firedeepActive = true;
					pV.firedeepProcCount++;
					if(event.timestamp <= pV.firedeepLastCast){
						rV.firedeepAmount -= pV.firedeepTemp;
						pV.firedeepActive = false;
						pV.firedeepProcCount--;
					}
					pV.firedeepTemp = 0;
				}
			},
			"cast", function(event,spellID){
				if(spellID == 114052) {
					pV.firedeepLastCast = event.timestamp + 500;
					rV.firedeepAmount -= pV.firedeepTemp;
					pV.firedeepActive = false;
					pV.firedeepTemp = 0;
				} else if (spellID == 73920) {
					pV.firedeepHRCount++;
				}
			},
		],
		obj: {
			type: "item",
			name: "Fire in the Deep",
			quality: 5,
			id: 151785,
			gear: "firedeepAmount",
			gearAdditionalText: function() { return "Proc rate: "+(pV.firedeepHRCount > 0 ? (pV.firedeepProcCount / pV.firedeepHRCount * 100).toFixed(1) : 0)+"%" },
		},
	},
	{	//Chalice of Moonlight
		init: function() {
			rV.chaliceofMoonlightAmount = 0;
		},
		parse: [
			"gear", function(itemData,itemID){
				if(itemID == 147005) {
					statsBuffs.crit[242544] = ScaleStat(3900,920,itemData.itemLevel);
					statsBuffs.haste[242543] = ScaleStat(3900,920,itemData.itemLevel);
				}
			}
		],
		afterParse: function() {
			rV.chaliceofMoonlightAmount += (rV.buffs.crit[242544] || 0) + (rV.buffs.haste[242543] || 0);
		},
		obj: {
			type: "item",
			name: "Chalice of Moonlight",
			quality: 4,
			id: 147005,
			gear: "chaliceofMoonlightAmount",
		},
	},
	{	//Charm of the Rising Tide
		init: function() {
			rV.charmOTRTAmount = 0;
			pV.charmOTRTLast10 = 0;
		},
		parse: [
			"applybuffstack", function(event,spellID){
				if(spellID == 242458 && event.stack == 10) {
					pV.charmOTRTLast10 = event.timestamp + 1000;
				}
			},
			"applybuff", function(event,spellID){
				if(spellID == 242458 && event.timestamp <= pV.charmOTRTLast10) {
					buffStatus[242458] = 10;
				}
			},
			"gear", function(itemData,itemID){
				if(itemID == 147002) {
					statsBuffs.haste[242458] = ScaleStat(609,915,itemData.itemLevel);
				}
			}
		],
		afterParse: function() {
			rV.charmOTRTAmount += (rV.buffs.haste[242458] || 0);
		},
		obj: {
			type: "item",
			name: "Charm of the Rising Tide",
			quality: 4,
			id: 147002,
			gear: "charmOTRTAmount",
		},
	},
	{	//Archive of Faith
		init: function() {
			rV.archiveofFaithAmount = 0;
		},
		afterParse: function() {
			if(healingData[242619])	rV.archiveofFaithAmount += healingData[242619][0];
			if(healingData[242621])	rV.archiveofFaithAmount += healingData[242621][0];
		},
		obj: {
			type: "item",
			name: "Archive of Faith",
			quality: 4,
			id: 147006,
			gear: "archiveofFaithAmount",
		},
	},
	{	//Ocean's Embrace
		init: function() {
			rV.oceansEmbraceAmount = 0;
			pV.oceansEmbraceFeedSpells = {
				108281: 0.6,
				114052: 1,
				157153: 0.25,			
			};
			pV.oceansEmbraceFeedAmount = {
				108281: 0,
				114052: 0,
				157153: 0,			
			};
			pV.oceansEmbraceFeedSpellsToHealSpell = {
				108281: 114083,
				114052: 114911,
				157153: 157503,			
			};			
		},
		parse: [
			"heal", function(event,spellID,amount,overheal){
				if(spellID == 242474){
					for (var j = 0, j_len = cooldownsTracking.length; j < j_len; j++) {
						if(cooldownsTracking[j].opened && pV.oceansEmbraceFeedSpells[ cooldownsTracking[j].spellID ]){
							pV.oceansEmbraceFeedAmount[ cooldownsTracking[j].spellID ] += (amount + overheal) * pV.oceansEmbraceFeedSpells[ cooldownsTracking[j].spellID ];
						}
					}
				}
			},
		],
		afterParse: function() {
			if(healingData[242474]) rV.oceansEmbraceAmount += healingData[242474][0];
			Object.keys(pV.oceansEmbraceFeedSpells).forEach(function (spellID) {
				var healSpellID = pV.oceansEmbraceFeedSpellsToHealSpell[spellID];
				if(healingData[healSpellID] && healingData[healSpellID][0] > 0){
					rV.oceansEmbraceAmount += pV.oceansEmbraceFeedAmount[spellID] * (healingData[healSpellID][0] / (healingData[healSpellID][0] + healingData[healSpellID][1]));
				}
			});			
		},
		obj: {
			type: "item",
			name: "Sea Star of the Depthmother",
			quality: 4,
			id: 147004,
			gear: "oceansEmbraceAmount",
			gearAdditionalText: function() { return "<em class=\"tooltip\">Why amount different?<span class=\"tip-text\" style=\"width: 300px;margin-left:-150px;\">This trinket also feed your CBT, AG and ASC. Additional average amount added to pure healing number.</span></em>" },
		},
	},
	{	//The Deceiver's Grand Design [kj]
		init: function() {
			rV.dgdAmount = 0;
			pV.dgdFeedSpells = {
				108281: 0.6,
				114052: 1,
				157153: 0.25,			
			};
			pV.dgdFeedAmount = {
				108281: 0,
				114052: 0,
				157153: 0,			
			};
			pV.dgdFeedSpellsToHealSpell = {
				108281: 114083,
				114052: 114911,
				157153: 157503,			
			};			
		},
		parse: [
			"heal", function(event,spellID,amount,overheal){
				if(spellID == 242622){
					for (var j = 0, j_len = cooldownsTracking.length; j < j_len; j++) {
						if(cooldownsTracking[j].opened && pV.dgdFeedSpells[ cooldownsTracking[j].spellID ]){
							pV.dgdFeedAmount[ cooldownsTracking[j].spellID ] += (amount + overheal) * pV.dgdFeedSpells[ cooldownsTracking[j].spellID ];
						}
					}
				}
			},
		],
		afterParse: function() {
			if(healingData[242622]) rV.dgdAmount += healingData[242622][0];
			if(healingData[242623]) rV.dgdAmount += healingData[242623][0];
			Object.keys(pV.dgdFeedSpells).forEach(function (spellID) {
				var healSpellID = pV.dgdFeedSpellsToHealSpell[spellID];
				if(healingData[healSpellID] && healingData[healSpellID][0] > 0){
					rV.dgdAmount += pV.dgdFeedAmount[spellID] * (healingData[healSpellID][0] / (healingData[healSpellID][0] + healingData[healSpellID][1]));
				}
			});			
		},
		obj: {
			type: "item",
			name: "The Deceiver's Grand Design",
			quality: 4,
			id: 147007,
			gear: "dgdAmount",
			gearAdditionalText: function() { return "<em class=\"tooltip\">Why amount different?<span class=\"tip-text\" style=\"width: 300px;margin-left:-150px;\">This trinket also feed your CBT, AG and ASC. Additional average amount added to pure healing number.</span></em>" },
		},
	},
	{	//2t21
		init: function() {
			rV.t21_2p_PredictionAmount = 0;
			rV.t21_2p_Amount = 0;
			pV.t21_2p_HRLast = 0;
			pV.t21_2p_gearCount = 0;
		},
		parse: [
			"heal", function(event,spellID,amount){
				if (spellID == 73921 && event.timestamp <= pV.t21_2p_HRLast){
					var heal = cV.intellect * 2.25;
					if(cV.traitInfo[1352]) heal *= 1.06;
					if(cV.traitInfo[1693]) heal *= 1.1;
					if(cV.traitInfo[1389]) heal *= 1.05;
					rV.t21_2p_PredictionAmount += heal;
				} else if (spellID == 252154) {
					rV.t21_2p_Amount += amount;
				}
			},
			"cast", function(event,spellID){
				if(spellID == 73920){
					pV.t21_2p_HRLast = event.timestamp + 500;
				}
			},
			"gear", function(itemData,itemID){
				if(itemID == 152166 || itemID == 152168 || itemID == 152169 || itemID == 152170 || itemID == 152171 || itemID == 152167) pV.t21_2p_gearCount++;
			}
		],
		obj: {
			type: "spell",
			name: "T21 2 set Bonus",
			quality: 10,
			id: 251764,
			prediction: "t21_2p_PredictionAmount",
			predictionСondition: function() { return pV.t21_2p_gearCount < 2 },
			gear: "t21_2p_Amount",
			gearFunc: function() { return pV.t21_2p_gearCount >= 2 },
			icon: "ability_shaman_ascendance.jpg",
		},
	},
	{	//4t21
		init: function() {
			rV.t21_4p_PredictionAmount = 0;
			rV.t21_4p_Amount = 0;
			pV.t21_4p_HRLast = 0;
			pV.t21_4p_gearCount = 0;
		},
		parse: [
			"heal", function(event,spellID,amount){
				if ((spellID == 77472 || spellID == 8004) && event.timestamp <= pV.t21_4p_HRLast){
					rV.t21_4p_PredictionAmount += amount * 0.6 * (cV.critSpell/40000+1);
				} else if (spellID == 252159) {
					rV.t21_4p_Amount += amount;
				}
			},
			"cast", function(event,spellID){
				if(spellID == 73920){
					pV.t21_4p_HRLast = event.timestamp + 10500;
				}
			},
			"gear", function(itemData,itemID){
				if(itemID == 152166 || itemID == 152168 || itemID == 152169 || itemID == 152170 || itemID == 152171 || itemID == 152167) pV.t21_4p_gearCount++;
			}
		],
		obj: {
			type: "spell",
			name: "T21 4 set Bonus",
			quality: 10,
			id: 251765,
			prediction: "t21_4p_PredictionAmount",
			predictionСondition: function() { return pV.t21_4p_gearCount < 4 },
			gear: "t21_4p_Amount",
			gearFunc: function() { return pV.t21_4p_gearCount >= 4 },
			icon: "ability_shaman_ascendance.jpg",
		},
	},
	{	//Sephuz
		parse: [
			"gear", function(itemData,itemID){
				if(itemID == 132452) {
					statsBuffs.haste_mod[-132452] = 1.02;
					buffStatus[-132452] = true;
				}
			}
		],
	},
	{	//Insignia ring
		init: function() {
			rV.insigniaringAmount = 0;
			rV.insigniaringPredictionAmount = 0;
		},
		afterParse: function() {			
			for (var i = 0, len = NETHERLIGHT.length; i < len; i++) {
				if(NETHERLIGHT[i].obj && !NETHERLIGHT[i].obj.fakeTrait){
					rV.insigniaringAmount += rV.netherlight[ NETHERLIGHT[i].obj.spellID ] * (1 - 1 / 1.5);
					rV.insigniaringPredictionAmount += rV.netherlight[ NETHERLIGHT[i].obj.spellID ] * 0.5;
				}
			}
		},
		obj: {
			type: "item",
			name: "Insignia of the Grand Army",
			quality: 5,
			id: 152626,
			prediction: "insigniaringPredictionAmount",
			gear: "insigniaringAmount",
		},
	},
];

var TRAITS = [
	{	//Grace [+6%]
		init: function() {
			rV.traits[1352] = 0;
		},
		parse: [
			"heal", function(event,spellID,amount,overheal){
				if(!OverallBlacklist[spellID]){
					//rV.traits[1352] += amount * (1 - 1 / 1.06);
					rV.traits[1352] += Math.max((amount + overheal) * (1 - 1 / 1.06) - overheal,0);
				}
			},
		],
		obj: {
			name: "Grace of the Sea",
			id: 1352,
			spellID: 224841,
			icon: "inv_elemental_crystal_water.jpg",
		},
	},
	{	//Echo [+10%]
		init: function() {
			rV.traits[1693] = 0;
		},
		parse: [
			"heal", function(event,spellID,amount,overheal){
				if(!OverallBlacklist[spellID]){
					//rV.traits[1693] += amount * (1 - 1 / 1.1);
					rV.traits[1693] += Math.max((amount + overheal) * (1 - 1 / 1.1) - overheal,0);
				}
			},
		],
		obj: {
			name: "Echo of the Earthen Ring",
			id: 1693,
			spellID: 241205,
			icon: "misc_legionfall_shaman.jpg",
		},
	},
	{	//+5%
		init: function() {
			rV.traits[1389] = 0;
		},
		parse: [
			"heal", function(event,spellID,amount,overheal){
				if(!OverallBlacklist[spellID]){
					rV.traits[1389] += Math.max((amount + overheal) * (1 - 1 / 1.05) - overheal,0);
				}
			},
		],
		obj: {
			name: "Flow of the Tides",
			id: 1389,
			spellID: 214933,
			icon: "inv_mace_1h_artifactazshara_d_02.jpg",
		},
	},
	{	//Paragon
		init: function() {
			rV.traits[1600] = 0;
		},
		parse: [
			"heal", function(event,spellID,amount){
				if(spellScaleInt[spellID]){
					if(pV.paragonTraitActive && GetTraitRank(1600) > 0){
						rV.traits[1600] += amount / cV.intellect * ((4000 + (GetTraitRank(1600) - 1) * 300) * 1.05);
					}
				}
			},
			"applybuff", function(event,spellID){
				if(spellID == 242586) pV.paragonTraitActive = true;
			},
			"removebuff", function(event,spellID){
				if(spellID == 242586) pV.paragonTraitActive = false;
			},
		],
		obj: {
			name: "Concordance of the Legionfall",
			id: 1600,
			spellID: 239042,
			icon: "trade_archaeology_sharkjaws.jpg",
			additionalText: function(){
				var rank = GetTraitRank(1600);
				if(rank == 1){
					return "";
				} else {
					var amount = ((rank * 300) / (rank*300  + 4000)) * rV.traits[1600];
					rank--;
					return "Per rank: "+NumberToFormattedNumber(amount / rank,0,2)+" ("+(amount / rank/rV.total*100).toFixed(2)+"%)";
				}	
			},
		},
	},
	{	//BL trait
		init: function() {
			rV.traits[1112] = 0;
			pV.trait1112Temp = 0;
		},
		parse: [
			"heal", function(event,spellID,amount,overheal){
				if(!OverallBlacklist[spellID]){
					if(pV.blTraitActive){
						//rV.traits[1112] += amount * (1 - 1 / 1.25);
						rV.traits[1112] += Math.max((amount + overheal) * (1 - 1 / 1.25) - overheal,0);
					} else {
						pV.trait1112Temp += Math.max((amount + overheal) * (1 - 1 / 1.25) - overheal,0);
					}
				}
			},
			"applybuff", function(event,spellID){
				if(spellID == 208416) pV.blTraitActive = true;
			},
			"removebuff", function(event,spellID){
				if(spellID == 208416) {
					if(!pV.blTraitActive){
						rV.traits[1112] += pV.trait1112Temp;
						pV.trait1112Temp = 0;
					}
					pV.blTraitActive = false;
				}
			},
		],
		obj: {
			name: "Sense of Urgency",
			id: 1112,
			spellID: 207355,
			icon: "inv_misc_pocketwatch_02.jpg",
		},
	},
	{	//CH crit trait
		init: function() {
			rV.traits[1109] = 0;
		},
		parse: [
			"heal", function(event,spellID,amount){
				if(spellID == 1064 && event.hitType == 2){
					rV.traits[1109] += pV.critAmount * ((GetTraitRank(1109) * 4 * 400) / pV.critNow);
				}
			},
		],
		obj: {
			name: "Floodwaters",
			id: 1109,
			spellID: 207348,
			icon: "spell_nature_healingwavegreater.jpg",
		},
	},
	{	//HR heal+crit trait
		init: function() {
			rV.traits[1107] = 0;
		},
		parse: [
			"heal", function(event,spellID,amount,overheal){
				if(spellID == 73921){
					if(event.hitType == 2) rV.traits[1107] += pV.critAmount * ((GetTraitRank(1107) * 2 * 400) / pV.critNow);
					//rV.traits[1107] += amount * (1 - 1 / (1 + 0.02 * GetTraitRank(1107)));
					rV.traits[1107] += Math.max((amount + overheal) * (1 - 1 / (1 + 0.02 * GetTraitRank(1107))) - overheal,0);
				}
			},
		],
		obj: {
			name: "Empowered Droplets",
			id: 1107,
			spellID: 207255,
			icon: "spell_nature_giftofthewaterspirit.jpg",
		},
	},
	{	//CH mana
		init: function() {
			rV.traits[1113] = 0;
		},
		afterParse: function() {
			rV.trait_1113 = rV.traits[1113];
			rV.traits[1113] = rV.traits[1113] / rV.manaUsage * rV.healFromMana;
		},
		parse: [
			"energize", function(event,spellID){
				if(spellID == 101033 && event.resourceChange == 4125){
					rV.traits[1113] += 1325;
				}
			},
		],
		obj: {
			name: "Refreshing Currents",
			id: 1113,
			spellID: 207356,
			icon: "ability_monk_cracklingjadelightning.jpg",
			additionalText: function(){
				return "Total mana gained: "+NumberToFormattedNumber(rV.trait_1113,0,2);
			},
		},
	},
	{	//HTT
		init: function() {
			rV.traits[1117] = 0;
			pV.httTraitLast = 0;
			pV.httTraitCount = 0;
		},
		parse: [
			"heal", function(event,spellID,amount,overheal){
				if(spellID == 114942){
					if((event["timestamp"] - pV.httTraitLast) > 15000){
						pV.httTraitCount = 0;
					} else if((event["timestamp"] - pV.httTraitLast) >= 300){
						pV.httTraitCount = Math.min(pV.httTraitCount + 1,7);
					}
					pV.httTraitLast = event["timestamp"];
					
					//rV.traits[1117] += amount * (1 - 1 / (1 + 0.1 * pV.httTraitCount));
					rV.traits[1117] += Math.max((amount + overheal) * (1 - 1 / (1 + 0.1 * pV.httTraitCount)) - overheal,0);
				}
			},
		],
		obj: {
			name: "Cumulative Upkeep",
			id: 1117,
			spellID: 207362,
			icon: "ability_shaman_healingtide.jpg",
		},
	},
	{	//HR +30
		init: function() {
			rV.traits[1598] = 0;
		},
		parse: [
			"heal", function(event,spellID,amount,overheal){
				if(spellID == 73921){
					//rV.traits[1598] += amount * (1 - 1 / 1.3);
					rV.traits[1598] += Math.max((amount + overheal) * (1 - 1 / 1.3) - overheal,0);
				}
			},
		],
		obj: {
			name: "Pitter-Patter",
			id: 1598,
			spellID: 242652,
			icon: "spell_nature_giftofthewaterspirit.jpg",
		},
	},
	{	//GotQ
		init: function() {
			rV.traits[1599] = 0;
			pV.gotqLast = 0;
			pV.gotqDisableOldDetect = false;
		},
		parse: [
			"heal", function(event,spellID,amount){
				if(spellID == 207778 && !pV.gotqDisableOldDetect){
					if((event["timestamp"] - pV.gotqLast) > 2000 && (event["timestamp"] - pV.gotqLast) < 4000){
						rV.traits[1599] += amount;
					}
				} else if (spellID == 255227){	//7.3 update
					rV.traits[1599] += amount;
					pV.gotqDisableOldDetect = true;
				}
			},
			"cast", function(event,spellID){
				if(spellID == 207778) pV.gotqLast = event["timestamp"];
			},
		],
		obj: {
			name: "Deep Waters",
			id: 1599,
			spellID: 238143,
			icon: "inv_mace_1h_artifactazshara_d_02.jpg",
		},
	},
	{	//QD [hst]
		init: function() {
			rV.traits[1116] = 0;
		},
		afterParse: function() {
			if(healingData[208899]) {
				rV.traits[1116] = healingData[208899][0];
			}
		},
		obj: {
			name: "Queen's Decree",
			id: 1116,
			spellID: 207360,
			icon: "inv_misc_volatilewater.jpg",
		},
	},
	{	//riptide totem
		init: function() {
			rV.traits[1115] = 0;
		},
		afterParse: function() {
			if(healingData[209069]) {
				rV.traits[1115] = healingData[209069][0];
			}
		},
		obj: {
			name: "Tidal Pools",
			id: 1115,
			spellID: 207358,
			icon: "achievement_dungeon_throneofthetides.jpg",
		},
	},
	{	//riptide
		init: function() {
			rV.traits[1105] = 0;
		},
		parse: [
			"heal", function(event,spellID,amount,overheal){
				if(spellID == 61295){
					//rV.traits[1105] += amount * (1 - 1 / (1 + 0.05 * GetTraitRank(1105)));
					rV.traits[1105] += Math.max((amount + overheal) * (1 - 1 / (1 + 0.05 * GetTraitRank(1105))) - overheal,0);
				}
			},
		],
		obj: {
			name: "Pull of the Sea",
			id: 1105,
			spellID: 210031,
			icon: "inv_tradeskillitem_sorcererswater.jpg",
		},
	},
	{	//hst speed
		init: function() {
			rV.traits[1106] = 0;
		},
		parse: [
			"heal", function(event,spellID,amount){
				if(spellID == 52042){
					rV.traits[1106] += amount * (1 - 1 / (1 + 0.1 * GetTraitRank(1106)));
				}
			},
		],
		obj: {
			name: "Wavecrash",
			id: 1106,
			spellID: 207206,
			icon: "inv_spear_04.jpg",
		},
	},
	{	//hw & surge
		init: function() {
			rV.traits[1104] = 0;
		},
		parse: [
			"heal", function(event,spellID,amount,overheal){
				if(spellID == 77472 || spellID == 8004){
					//rV.traits[1104] += amount * (1 - 1 / (1 + 0.05 * GetTraitRank(1104)));
					rV.traits[1104] += Math.max((amount + overheal) * (1 - 1 / (1 + 0.05 * GetTraitRank(1104))) - overheal,0);
				}
			},
		],
		obj: {
			name: "Buffeting Waves",
			id: 1104,
			spellID: 207092,
			icon: "ability_skyreach_four_wind.jpg",
		},
	},
	{	//tidal buff
		init: function() {
			rV.traits[1103] = 0;
			rV.traits1103_CastTime = 0;
			rV.traits1103_Crit = 0;
			pV.traits1103_TidalLoss = 0;
			pV.traits1103_HRStartCast = 0;
			pV.traits1103_HRCastTime = 0;
		},
		parse: [
			"heal", function(event,spellID,amount){
				if((spellID == 77472 || spellID == 8004) && (event.timestamp <= pV.hwWithoutTidalLoss)){
					if(spellID == 8004 && event.hitType == 2){
						rV.traits1103_Crit += ( GetTraitRank(1103) * 4 * 400 ) / pV.critNow * pV.critAmount;;
					} else if(spellID == 77472) {
						var tidal = (GetTraitRank(1103) * 0.03);
						rV.traits1103_CastTime += pV.traits1103_HRCastTime / (1 - tidal) * tidal;
					}
				}
			},
			"removebuff", function(event,spellID){
				if(spellID == 53390) pV.traits1103_TidalLoss = event.timestamp + 500;
			},
			"removebuffstack", function(event,spellID){
				if(spellID == 53390) pV.traits1103_TidalLoss = event.timestamp + 500;
			},
			"begincast", function(event,spellID){
				if(spellID == 77472) pV.traits1103_HRStartCast = event.timestamp;
			},
			"cast", function(event,spellID){
				if(spellID == 77472) {
					pV.traits1103_HRCastTime = event.timestamp - pV.traits1103_HRStartCast;
				}
			},			
		],
		afterParse: function() {
			var hps = rV.total / (currFightData.end_time - currFightData.start_time);
			
			rV.traits[1103] = rV.traits1103_Crit + hps * rV.traits1103_CastTime;
		},		
		obj: {
			name: "Tidal Chains",
			id: 1103,
			spellID: 207088,
			icon: "spell_frost_chainsofice.jpg",
			tip: function() { return "From surge crit: "+NumberToFormattedNumber(rV.traits1103_Crit,0,2)+"<br>Reduced HW cast time: "+(rV.traits1103_CastTime/1000).toFixed(1)+"s" },
		},
	},
	{	//QA
		init: function() {
			rV.traits[1108] = 0;
			rV.traits1108_CastTime = 0;
			pV.traits1108_LastCast = 0;
			pV.traits1108_QALoss = 0;
		},
		parse: [
			"applybuff", function(event,spellID){
				if(spellID == 207288) pV.traits1108_QAActive = true;
			},
			"removebuff", function(event,spellID){
				if(spellID == 207288) pV.traits1108_QAActive = false;
			},
			"begincast", function(event,spellID){
				if(spellID == 77472 || spellID == 8004 || spellID == 1064) pV.traits1108_LastCast = event.timestamp;
			},
			"cast", function(event,spellID){
				if(pV.traits1108_QAActive && (spellID == 77472 || spellID == 8004 || spellID == 1064)) {
					var castTime = event.timestamp - pV.traits1108_LastCast;
					
					var trait = (GetTraitRank(1108) * 0.05);
					
					rV.traits1108_CastTime += castTime / (1 - trait) * trait;
				}
			},			
		],
		afterParse: function() {
			var hps = rV.total / (currFightData.end_time - currFightData.start_time);
			
			rV.traits[1108] = hps * rV.traits1108_CastTime;
		},		
		obj: {
			name: "Queen Ascendant",
			id: 1108,
			spellID: 207288,
			icon: "ability_shaman_watershield.jpg",
			tip: function() { return "Reduced cast time: "+(rV.traits1108_CastTime/1000).toFixed(1)+"s<br>To value heal number used HPS*Reduced time" },
		},
	},	
];

NETHERLIGHT = [
	{	//Infusion of Light
		init: function() {
			rV.netherlight[253093] = 0;
		},
		afterParse: function() {
			if(healingData[253099]) {
				rV.netherlight[253093] = healingData[253099][0];
			}
		},		
		obj: {
			name: "Infusion of Light",
			spellID: 253093,
			icon: "ability_malkorok_blightofyshaarj_yellow.jpg",
		},
	},	
	{	//Secure in the Light
		init: function() {
			rV.netherlight[253070] = 0;
		},
		afterParse: function() {
			if(healingData[253072]) {
				rV.netherlight[253070] = healingData[253072][0];
			}
		},		
		obj: {
			name: "Secure in the Light",
			spellID: 253070,
			icon: "ability_paladin_toweroflight.jpg",
		},
	},
	{	//Light Speed
		init: function() {
			rV.netherlight[252088] = 0;
		},
		afterParse: function() {
			var rank = 1;
			var perRankBonus = cV.gearInfo[152626] ? 750 : 500;
			if(cV.traitBySpell[252088]) rank = cV.traitBySpell[252088].rank || 1;
			rV.netherlight[252088] = healPerStat["haste"].amount * perRankBonus * rank;
		},		
		obj: {
			name: "Light Speed",
			spellID: 252088,
			icon: "ability_rogue_sprint.jpg",
		},
	},
	{	//Master of Shadows
		init: function() {
			rV.netherlight[252091] = 0;
		},
		afterParse: function() {
			var rank = 1;
			var perRankBonus = cV.gearInfo[152626] ? 750 : 500;
			if(cV.traitBySpell[252091]) rank = cV.traitBySpell[252091].rank || 1;
			rV.netherlight[252091] = healPerStat["mastery"].amount * perRankBonus * rank;
		},		
		obj: {
			name: "Master of Shadows",
			spellID: 252091,
			icon: "spell_shadow_shadesofdarkness.jpg",
		},
	},
	{	//Shocklight
		init: function() {
			rV.netherlight[252799] = 0;
		},
		parse: [
			"combantantInfo", function(event){
				var perRankBonus = cV.gearInfo[152626] ? 2250 : 1500;
				for (var k = 0, k_len = event.artifact.length; k < k_len; k++) {
					var traitData = event.artifact[k];
					if( traitData.spellID == 252799 ){
						statsBuffs.crit[242586] = perRankBonus * (traitData.rank || 1);
					}
				}
			}
		],		
		afterParse: function() {
			if(rV.buffs.crit[242586]) {
				rV.netherlight[252799] = rV.buffs.crit[242586];
			}
			
			delete statsBuffs.crit[242586];
		},		
		obj: {
			name: "Shocklight",
			spellID: 252799,
			icon: "paladin_icon_speedoflight.jpg",
		},
	},
	{	//Murderous Intent
		init: function() {
			rV.netherlight[252191] = 0;
		},
		parse: [
			"combantantInfo", function(event){
				var perRankBonus = cV.gearInfo[152626] ? 2250 : 1500;
				for (var k = 0, k_len = event.artifact.length; k < k_len; k++) {
					var traitData = event.artifact[k];
					if( traitData.spellID == 252191 ){
						statsBuffs.vers[242586] = perRankBonus * (traitData.rank || 1);
					}
				}
			}
		],	
		afterParse: function() {
			if(rV.buffs.vers[242586]) {
				rV.netherlight[252191] = rV.buffs.vers[242586];
			}
			
			delete statsBuffs.vers[242586];
		},		
		obj: {
			name: "Murderous Intent",
			spellID: 252191,
			icon: "spell_shadow_charm.jpg",
		},
	},
	{	//Refractive Shell
		init: function() {
			rV.netherlight[252207] = 0;
		},
		afterParse: function() {
			if(healingData[252208]) {
				rV.netherlight[252207] = healingData[252208][0];
			}
		},		
		obj: {
			name: "Refractive Shell",
			spellID: 252207,
			icon: "ability_priest_reflectiveshield.jpg",
		},
	},
	{	//Light's Embrace
		init: function() {
			rV.netherlight[253111] = 0;
		},
		afterParse: function() {
			if(healingData[253216]) {
				rV.netherlight[253111] = healingData[253216][0];
			}
		},		
		obj: {
			name: "Light's Embrace",
			spellID: 253111,
			icon: "achievement_reputation_07.jpg",
		},
	},
	{	//Chaotic Darkness
		init: function() {
			rV.netherlight[252888] = 0;
		},
		afterParse: function() {
			if(healingData[252897]) {
				rV.netherlight[252888] = healingData[252897][0];
			}
		},		
		obj: {
			name: "Chaotic Darkness",
			spellID: 252888,
			icon: "inv_artifact_powerofthedarkside.jpg",
		},
	},
	{	//Shadowbind
		init: function() {
			rV.netherlight[252875] = 0;
		},
		afterParse: function() {
			if(healingData[252879]) {
				rV.netherlight[252875] = healingData[252879][0];
			}
		},		
		obj: {
			name: "Shadowbind",
			spellID: 252875,
			icon: "spell_shadow_deathpact.jpg",
		},
	},
	{	//+1 ilvl
		init: function() {
			rV.netherlight[-1] = 0;
			
			pV.netherlightIlvlCurrWeapon = 750;
		},
		parse: [
			"gear", function(itemData,itemID){
				if(itemID == 128911) pV.netherlightIlvlCurrWeapon = itemData.itemLevel;
			}
		],
		afterParse: function() {
			var items = [128911, 128934];
			var stats = ["int","crit","mastery"];
			for (var i = 0, len = items.length; i < len; i++) {
				var itemData = itemsStats[ items[i] ];
				for (var j = 0, j_len = stats.length; j < j_len; j++) {
					var statName = stats[j];
					
					var valDef = ScaleStat(itemData[statName],itemData.ilvl,pV.netherlightIlvlCurrWeapon,statName == "int" ? 1 : 0);
					var valBuffed = ScaleStat(itemData[statName],itemData.ilvl,pV.netherlightIlvlCurrWeapon + 1,statName == "int" ? 1 : 0)
					
					rV.netherlight[-1] += (valBuffed - valDef) * healPerStat[statName].amount;
				}
			}
			
		},		
		obj: {
			name: "+1 weapon item level",
			spellID: -1,
			icon: "inv_mace_1h_artifactazshara_d_02.jpg",
			tip: function() { return "Not real trait. Just for compare numbers" },
			fakeTrait: true,
		},
	},
];

var TALENTS = [
	{	//CBT
		init: function() {
			rV.talents[157153] = 0;
		},
		afterParse: function() {
			if(healingData[157503]) {
				rV.talents[157153] = healingData[157503][0];
			}
		},
		obj: {
			name: "Cloudburst Totem",
			id: 157153,
		},
	},
	{	//Torrent
		init: function() {
			rV.talents[200072] = 0;
		},
		parse: [
			"heal", function(event,spellID,amount,overheal){
				if(spellID == 61295 && !event.tick){
					//rV.talents[200072] += amount * (1 - 1 / 1.3);
					rV.talents[200072] += Math.max((amount + overheal) * (1 - 1 / 1.3) - overheal,0);
				}
			},
		],
		obj: {
			name: "Torrent",
			id: 200072,
		},
	},
	{	//UL
		init: function() {
			rV.talents[73685] = 0;
			pV.ulLossTime = 0;
		},
		parse: [
			"heal", function(event,spellID,amount,overheal){
				if((event.timestamp - pV.ulLossTime) <= 300 && ((spellID == 61295 && !event.tick) || spellID == 77472 || spellID == 8004 || spellID == 1064)){
					//rV.talents[73685] += amount * (1 - 1 / 1.45);
					rV.talents[73685] += Math.max((amount + overheal) * (1 - 1 / 1.45) - overheal,0);
				} else if(spellID == 73685){
					rV.talents[73685] += amount;
				}
			},
			"removebuff", function(event,spellID){
				if(spellID == 73685) pV.ulLossTime = event.timestamp;
			},
		],
		obj: {
			name: "Unleash Life",
			id: 73685,
		},
	},
	{	//AG
		init: function() {
			rV.talents[108281] = 0;
		},
		afterParse: function() {
			if(healingData[114911]) {
				rV.talents[108281] = healingData[114911][0];
			}
		},
		obj: {
			name: "Ancestral Guidance",
			id: 108281,
		},
	},
	{	//EST
		init: function() {
			rV.talents[198838] = 0;
		},
		afterParse: function() {
			if(healingData[201633]) {
				rV.talents[198838] = healingData[201633][0];
			}
		},
		obj: {
			name: "Earthen Shield Totem",
			id: 198838,
		},
	},
	{	//Ascendance
		init: function() {
			rV.talents[114052] = 0;
		},
		afterParse: function() {
			if(healingData[114083]) {
				rV.talents[114052] = healingData[114083][0];
			}
		},
		obj: {
			name: "Ascendance",
			id: 114052,
		},
	},
	{	//Wellspring
		init: function() {
			rV.talents[197995] = 0;
		},
		afterParse: function() {
			if(healingData[197997]) {
				rV.talents[197995] = healingData[197997][0];
			}
		},
		obj: {
			name: "Wellspring",
			id: 197995,
		},
	},
	{	//highTide
		init: function() {
			rV.talents[157154] = 0;
			pV.highTideBounds = 0;
		},
		parse: [
			"heal", function(event,spellID,amount){
				if(spellID == 1064){
					if(pV.highTideBounds >= 4)
						rV.talents[157154] += amount;
					else
						rV.talents[157154] += amount * (1 - ( Math.pow(0.7,pV.highTideBounds) / Math.pow(0.85,pV.highTideBounds) ) );
					pV.highTideBounds++;
				}
			},
			"cast", function(event,spellID){
				if(spellID == 1064) pV.highTideBounds = 0;
			},
		],
		obj: {
			name: "High Tide",
			id: 157154,
		},
	},
	{	//undulation
		init: function() {
			rV.talents[200071] = 0;
			pV.undulationLossTime = 0;
		},
		parse: [
			"heal", function(event,spellID,amount,overheal){
				if((spellID == 77472 || spellID == 8004) && ((event.timestamp - pV.undulationLossTime) <= 300)){
					//rV.talents[200071] += amount * (1 - 1 / 1.5);
					rV.talents[200071] += Math.max((amount + overheal) * (1 - 1 / 1.5) - overheal,0);
				}
			},
			"removebuff", function(event,spellID){
				if(spellID == 216251) pV.undulationLossTime = event.timestamp;
			},
		],
		obj: {
			name: "Undulation",
			id: 200071,
		},
	},	
];

var RESURGENCE = [
	{	//surge
		init: function() {
			rV.resurgence[8004] = [0,0];
		},
		parse: [
			"cast", function(event,spellID){
				if(spellID == 8004) pV.resurgenceLast6600 = 8004;
			},
			"energize", function(event,spellID){
				if(event.resourceChange == 6600 && spellID == 101033 && pV.resurgenceLast6600 == 8004) {
					rV.resurgence[8004][0] += event.resourceChange;
					rV.resurgence[8004][1] ++;
				}
			},
		],
		obj: {
			id: 8004,
			name: "Healing Surge",
			icon: "spell_nature_healingway.jpg",
		},
	},
	{	//riptide
		init: function() {
			rV.resurgence[61295] = [0,0];
		},
		parse: [
			"cast", function(event,spellID){
				if(spellID == 61295) pV.resurgenceLast6600 = 61295;
			},
			"energize", function(event,spellID){
				if(event.resourceChange == 6600 && spellID == 101033 && pV.resurgenceLast6600 == 61295) {
					rV.resurgence[61295][0] += event.resourceChange;
					rV.resurgence[61295][1] ++;
				}
			},
		],
		obj: {
			id: 61295,
			name: "Riptide",
			icon: "spell_nature_riptide.jpg",
		},
	},
	{	//ul
		init: function() {
			rV.resurgence[73685] = [0,0];
		},
		parse: [
			"cast", function(event,spellID){
				if(spellID == 73685) pV.resurgenceLast6600 = 73685;
			},
			"energize", function(event,spellID){
				if(event.resourceChange == 6600 && spellID == 101033 && pV.resurgenceLast6600 == 73685) {
					rV.resurgence[73685][0] += event.resourceChange;
					rV.resurgence[73685][1] ++;
				}
			},
		],
		obj: {
			id: 73685,
			name: "Unleash Life",
			icon: "spell_shaman_unleashweapon_life.jpg",
		},
	},
	{	//ch
		init: function() {
			rV.resurgence[1064] = [0,0];
		},
		parse: [
			"energize", function(event,spellID){
				if((event.resourceChange == 4125 || event.resourceChange == 2750) && spellID == 101033) {
					rV.resurgence[1064][0] += event.resourceChange;
					rV.resurgence[1064][1] ++;
				}
			},
		],
		obj: {
			id: 1064,
			name: "Chain Heal",
			icon: "spell_nature_healingwavegreater.jpg",
		},
	},
	{	//hw
		init: function() {
			rV.resurgence[77472] = [0,0];
		},
		parse: [
			"energize", function(event,spellID){
				if(event.resourceChange == 11000 && spellID == 101033) {
					rV.resurgence[77472][0] += event.resourceChange;
					rV.resurgence[77472][1] ++;
				}
			},
		],
		obj: {
			id: 77472,
			name: "Healing Wave",
			icon: "spell_nature_healingwavelesser.jpg",
		},
	},
];
var POTIONS = [
	{
		init: function() {
			rV.potions[188016] = 0;
		},
		parse: [
			"heal", function(event,spellID,amount){
				if(spellID == 188016) {
					rV.potions[188016] += amount;
				}
			},
		],
		obj: {
			id: 188016,
			name: "Ancient Healing Potion",
			icon: "inv_alchemy_70_red.jpg",
		},
	},
	{
		init: function() {
			rV.potions[229206] = 0;
			rV.prolongedTemp = 0;
		},
		parse: [
			"heal", function(event,spellID,amount){
				if(spellScaleInt[spellID]){
					if(pV.prolongedActive){
						rV.potions[229206] += amount / cV.intellect * 2500 * 1.05;
					} else {
						rV.prolongedTemp += amount / cV.intellect * 2500 * 1.05;
					}
				}
			},
			"applybuff", function(event,spellID){
				if(spellID == 229206) pV.prolongedActive = true;
			},
			"removebuff", function(event,spellID){
				if(spellID == 229206) {
					if(!pV.prolongedActive) rV.potions[229206] = rV.prolongedTemp;
					pV.prolongedActive = false;
				}
			},			
		],
		obj: {
			id: 229206,
			name: "Potion of Prolonged Power",
			icon: "trade_alchemy_dpotion_a28.jpg",
		},
	},
	{
		init: function() {
			rV.potions[188017] = 0;
		},
		parse: [
			"energize", function(event,spellID){
				if(spellID == 188017) rV.potions[188017] += event.resourceChange;
			},		
		],
		obj: {
			id: 188017,
			name: "Ancient Mana Potion",
			icon: "inv_alchemy_70_blue.jpg",
			text: function(){
				var amount = rV.potions[188017] / rV.manaUsage * rV.healFromMana;
			
				return "Mana gained: <em class=\"result\">"+NumberToFormattedNumber(rV.potions[188017],0,2)+"</em> ("+(rV.potions[188017]/rV.manaUsage*100).toFixed(2)+"%)<br>Helaing: <em class=\"result-hps\">"+NumberToFormattedNumber(amount,0,2)+"</em> ("+(amount/rV.total*100).toFixed(2)+"%)";
			},
		},
	},
	{
		init: function() {
			rV.potions[188030] = 0;
		},
		parse: [
			"energize", function(event,spellID){
				if(spellID == 188030) rV.potions[188030] += event.resourceChange;
			},		
		],
		obj: {
			id: 188030,
			name: "Leytorrent Potion",
			icon: "inv_alchemy_70_flask01.jpg",
			text: function(){
				var amount = rV.potions[188030] / rV.manaUsage * rV.healFromMana;
			
				return "Mana gained: <em class=\"result\">"+NumberToFormattedNumber(rV.potions[188030],0,2)+"</em> ("+(rV.potions[188030]/rV.manaUsage*100).toFixed(2)+"%)<br>Helaing: <em class=\"result-hps\">"+NumberToFormattedNumber(amount,0,2)+"</em> ("+(amount/rV.total*100).toFixed(2)+"%)";
			},
		},
	},
];
var OTHER = [
	{	//HW or Surge without tidal
		init: function() {
			rV.hwWithoutTidal = 0;
			rV.hwWithoutTidalTotal = 0;
			pV.hwWithoutTidalLoss = 0;
		},
		parse: [
			"heal", function(event,spellID,amount){
				if(spellID == 77472 || spellID == 8004){
					if(!(event.timestamp <= pV.hwWithoutTidalLoss)) rV.hwWithoutTidal ++;	
					rV.hwWithoutTidalTotal++;
				}
			},
			"removebuff", function(event,spellID){
				if(spellID == 53390) pV.hwWithoutTidalLoss = event.timestamp + 500;
			},
			"removebuffstack", function(event,spellID){
				if(spellID == 53390) pV.hwWithoutTidalLoss = event.timestamp + 500;
			},
		],
	},
	{	//Spiritwalker's Grace
		init: function() {
			rV.spiritwalkerUptime = 0;
			pV.spiritwalkerLast = 0;
		},
		parse: [
			"removebuff", function(event,spellID){
				if(spellID == 79206 && pV.spiritwalkerLast > 0) rV.spiritwalkerUptime += event.timestamp - pV.spiritwalkerLast;
			},
			"applybuff", function(event,spellID){
				if(spellID == 79206) pV.spiritwalkerLast = event.timestamp;
			},
		],
	},
	{	//Wolf
		init: function() {
			rV.wolfUptime = 0;
			pV.wolfLast = 0;
		},
		parse: [
			"removebuff", function(event,spellID){
				if(spellID == 2645 && pV.wolfLast > 0) rV.wolfUptime += event.timestamp - pV.wolfLast;
			},
			"applybuff", function(event,spellID){
				if(spellID == 2645) pV.wolfLast = event.timestamp;
			},
		],
	},
	{	//Fix
		init: function() {
			pV.critTidalLoss = 0;
			function CreateStatData() {return {amount:0,total:0,avg:0,avgCount:0,all:0,buffs:[],spells:[]} };
			function CreateCDData() {
				return {
					int: CreateStatData(),
					haste: CreateStatData(),
					mastery: CreateStatData(),
					vers: CreateStatData(),
					crit: CreateStatData(),
					time:0,
					feed:0,
					spellsfeed:[],
				}; 
			};
			
			pV.buffAG = CreateCDData();
			pV.buffAG.buffASC = CreateCDData();
			pV.buffAG.buffCBT = CreateCDData();
			
			pV.buffASC = CreateCDData();
			
			pV.buffCBT = CreateCDData();
			pV.buffCBT.buffASC = CreateCDData();
			pV.buffCBT.buffAG = CreateCDData();
		},
		parse: [
			"applybuff", function(event,spellID){
				if(spellID == 108281) {		//Ancestral Guidance
					pV.buffAG.time = event.timestamp + 11000;
					pV.buffAGActive = true;
				} else if(spellID == 114052) {	//Ascendance
					pV.buffASC.time = event.timestamp + 16000;
					pV.buffASCActive = true;
				}
			},
			"removebuff", function(event,spellID){
				if(spellID == 108281) {		//Ancestral Guidance
					pV.buffAG.time = 0;
					pV.buffAGActive = false;
				} else if(spellID == 114052) {	//Ascendance
					pV.buffASC.time = 0;
					pV.buffASCActive = false;
				}
			},
			"cast", function(event,spellID){
				if(spellID == 157153) {	//CBT
					pV.buffCBT.time = event.timestamp + 15500;
					pV.buffCBTActive = true;
				} else if (spellID == 201764) {	//return CBT
					pV.buffCBT.time = 0;
					pV.buffCBTActive = false;
				}
			}
		],
		afterParse: function() {
			var statsList = ["int","haste","mastery","vers","crit"];
			var dSL = ["buffAG","buffASC","buffCBT"];
			for (var j = 0, j_len = delayedSpells.length; j < j_len; j++) {
				var spellData = delayedSpells[j];
				if(healingData[ spellData[1] ]) {
					pV[ spellData[0] ].itself = healingData[ spellData[1] ][0];
				}
			}
			for (var j = 0, j_len = delayedSpells.length; j < j_len; j++) {
				var spellData = delayedSpells[j];
				var CDdata = pV[ spellData[0] ];
				var itself = 0;
				if(healingData[ spellData[1] ]) {
					itself = healingData[ spellData[1] ][0];
				}
				if(itself > 0 && CDdata.feed > 0){
					var p = itself / CDdata.feed;
					CDdata.mod = p;
					for (var k = 0, k_len = statsList.length; k < k_len; k++) {
						var stat = statsList[k];				
						healPerStat[stat].amount += CDdata[stat].amount * p;
						healPerStat[stat].total += CDdata[stat].total * p;
						healPerStat[stat].avg += CDdata[stat].avg * p;
						healPerStat[stat].avgCount += CDdata[stat].avgCount * p;
						healPerStat[stat].all += CDdata[stat].all * p;
						
						if(!healPerStat[stat].spells) healPerStat[stat].spells = {};
						healPerStat[stat].spells[ spellData[1] ] = (healPerStat[stat].spells[ spellData[1] ] || 0) + CDdata[stat].amount * p;
						
						Object.keys(CDdata[stat].buffs).forEach(function (buffSpellID) {
							if(!rV.buffs[stat][buffSpellID]) rV.buffs[stat][buffSpellID] = 0;
							rV.buffs[stat][buffSpellID] += CDdata[stat].buffs[buffSpellID] * p;
						});
					}
					for (var k = 0, k_len = dSL.length; k < k_len; k++) {
						var nCDdata = CDdata[ dSL[k] ];
						if(nCDdata && pV[ dSL[k] ].feed > 0){
							var p2 = pV[ dSL[k] ].itself / pV[ dSL[k] ].feed;
							for (var l = 0, l_len = statsList.length; l < l_len; l++) {
								var stat = statsList[l];			
								healPerStat[stat].amount += nCDdata[stat].amount * p * p2;
								healPerStat[stat].total += nCDdata[stat].total * p * p2;
								healPerStat[stat].avg += nCDdata[stat].avg * p * p2;
								healPerStat[stat].avgCount += nCDdata[stat].avgCount * p * p2;
								healPerStat[stat].all += nCDdata[stat].all * p * p2;
								
								if(!healPerStat[stat].spells) healPerStat[stat].spells = {};
								healPerStat[stat].spells[ spellData[1] ] = (healPerStat[stat].spells[ spellData[1] ] || 0) + nCDdata[stat].amount * p * p2;
								
								Object.keys(nCDdata[stat].buffs).forEach(function (buffSpellID) {
									if(!rV.buffs[stat][buffSpellID]) rV.buffs[stat][buffSpellID] = 0;
									rV.buffs[stat][buffSpellID] += nCDdata[stat].buffs[buffSpellID] * p * p2;
								});							
							}
						}
					}
				}
			}
		},
	},
	{	//Crit resurgence
		init: function() {
			rV.resurgenceCrit = 0;
			rV.resurgenceCritAmount = 0;
			pV.resurgenceCritAvg = 0;
			pV.resurgenceCritCount = 0;
		},
		parse: [
			"heal", function(event,spellID,amount){
				if((spellID == 8004 || (spellID == 61295 && !event.tick) || spellID == 73685 || spellID == 1064 || spellID == 77472) && event.hitType == 2){
					pV.resurgenceCritAvg += pV.critNow;
					pV.resurgenceCritCount ++;
				}
			},
			"energize", function(event,spellID){
				if(spellID == 101033) rV.resurgenceCrit += event.resourceChange;
			},
		],
		afterParse: function() {
			rV.resurgenceCritAmount = pV.resurgenceCritAvg / pV.resurgenceCritCount;
		},
	},
];



var parsePlugins = {
	heal: [],
	applybuff: [],
	applybuffstack: [],
	removebuff: [],
	removebuffstack: [],
	cast: [],
	begincast: [],
	damage: [],
	energize: [],
	gear: [],
	combantantInfo: [],
};

var pluginsList = [OTHER, NETHERLIGHT, ITEMS, TRAITS, TALENTS, RESURGENCE, POTIONS];
for (var k = 0, k_len = pluginsList.length; k < k_len; k++) {
	var pluginData = pluginsList[k];
	for (var i = 0, len = pluginData.length; i < len; i++) {
		if(pluginData[i].parse){
			for (var j = 0, j_len = pluginData[i].parse.length; j < j_len; j=j+2) {
				parsePlugins[ pluginData[i].parse[j] ].push(pluginData[i].parse[j+1]);
			}
		}
	}
}

var multiplicateCDs = [
	[function(sid,timestamp){if(sid==114911 && timestamp <= pV.buffCBT.time) return true;},"buffCBT","buffAG"],
	[function(sid,timestamp){if(sid==114083 && timestamp <= pV.buffCBT.time) return true;},"buffCBT","buffASC"],
	[function(sid,timestamp){if(sid==157503 && timestamp <= pV.buffAG.time) return true;},"buffAG","buffCBT"],
	[function(sid,timestamp){if(sid==114083 && timestamp <= pV.buffAG.time) return true;},"buffAG","buffASC"],
];

function AddStatAmount(stat,amount,amountWithOh,statNow,totalHeal,spellID,timestamp){
	Object.keys(statsBuffs[stat]).forEach(function (buffSpellID) {
		if(buffStatus[buffSpellID]){
			if(!rV.buffs[stat][buffSpellID]) rV.buffs[stat][buffSpellID] = 0;
			rV.buffs[stat][buffSpellID] += statsBuffs[stat][buffSpellID] / statNow * amount * (typeof(buffStatus[buffSpellID]) == "number" ? buffStatus[buffSpellID] : 1);
		}
	});

	healPerStat[stat].amount += amount / statNow;
	healPerStat[stat].total += amount;
	var healWOstat = stat == "int" ? amount : (totalHeal - amount);
	healPerStat[stat].avg += statNow * healWOstat;
	healPerStat[stat].avgCount += healWOstat;
	healPerStat[stat].all += totalHeal;
	if(!healPerStat[stat].spells) healPerStat[stat].spells = {};
	healPerStat[stat].spells[spellID] = (healPerStat[stat].spells[spellID] || 0) + amount / statNow;
	
	var timeGraph = Math.floor((timestamp - currFightData.start_time) / 1000 / STATS_GRAPH_STEP);
	if(!healPerStat.graph[timeGraph]) healPerStat.graph[timeGraph] = CreateHealPerStatTable();

	healPerStat.graph[timeGraph][stat].amount += amount / statNow;
	healPerStat.graph[timeGraph][stat].total += amount;
	healPerStat.graph[timeGraph][stat].avg += statNow * healWOstat;
	healPerStat.graph[timeGraph][stat].avgCount += healWOstat;
	healPerStat.graph[timeGraph][stat].all += totalHeal;
	
	for (var j = 0, j_len = delayedSpells.length; j < j_len; j++) {
		var CDdata = pV[ delayedSpells[j][0] ];
		if(!delayedSpells[j][2][spellID] && timestamp <= CDdata.time){
			CDdata[stat].amount += amountWithOh / statNow;
			CDdata[stat].total += amountWithOh;
			CDdata[stat].avg += statNow * amountWithOh;
			CDdata[stat].avgCount += amountWithOh;
			CDdata[stat].all += totalHeal;			

			if(!CDdata[stat].spells) CDdata[stat].spells = {};
			CDdata[stat].spells[spellID] = (CDdata[stat].spells[spellID] || 0) + totalHeal;	

			
			Object.keys(statsBuffs[stat]).forEach(function (buffSpellID) {
				if(buffStatus[buffSpellID]){
					if(!CDdata[stat].buffs[buffSpellID]) CDdata[stat].buffs[buffSpellID] = 0;
					CDdata[stat].buffs[buffSpellID] += statsBuffs[stat][buffSpellID] / statNow * amountWithOh;
				}
			});
			
			for (var k = 0, k_len = multiplicateCDs.length; k < k_len; k++) {
				if(multiplicateCDs[k][0](delayedSpells[j][1],timestamp)) {
					CDdata = pV[ multiplicateCDs[k][1] ][ multiplicateCDs[k][2] ];
				
					CDdata[stat].amount += amountWithOh / statNow;
					CDdata[stat].total += amountWithOh;
					CDdata[stat].avg += statNow * amountWithOh;
					CDdata[stat].avgCount += amountWithOh;
					CDdata[stat].all += totalHeal;			
					
					Object.keys(statsBuffs[stat]).forEach(function (buffSpellID) {
						if(buffStatus[buffSpellID]){
							if(!CDdata[stat].buffs[buffSpellID]) CDdata[stat].buffs[buffSpellID] = 0;
							CDdata[stat].buffs[buffSpellID] += statsBuffs[stat][buffSpellID] / statNow * amountWithOh;
						}
					});			
				}
			}
		}
	}
}

function ParseLog(fight_code,actor_id,start_time,end_time)
{
	$.getJSON( "https://www.warcraftlogs.com:443/v1/report/events/"+fight_code+"?start="+start_time+"&end="+end_time+"&actorid="+actor_id+"&api_key="+WCL_API_KEY ).done( function( data ) {
		if(data.status == 400){
			error_msg(data.error);
			throw new Error("Error: Parsing Error");
		}
		actors[actor_id] = true
		
		try {

		for (var i = 0, len = data.events.length; i < len; i++) {
			var event = data.events[i];

			var resourceActorNow = event.resourceActor == 1 ? event.sourceID : event.targetID;
			
			if(resourceActorNow == actor_id && event.spellPower){
				cV.intellect = event.spellPower;
				cV.intellect_min = Math.min(cV.intellect_min, cV.intellect);
			}
			
			if((event.type == "heal" || event.type == "absorbed") && actors[event.sourceID]){
				var spellID = event.ability.guid;
				if(!healingData[spellID]){
					healingData[spellID] = [0,0];
				}
				var amount = event.amount;
				var overheal = event.overheal || 0;
 				if(event.absorbed) amount += event.absorbed;
 				if(event.absorb) amount += event.absorb;
				healingData[spellID][0] += amount;
				if(event.overheal) healingData[spellID][1] += event.overheal;
				
				if(healingFromMana[spellID]){
					rV.healFromMana += amount * healingFromMana[spellID];
				}
				
				if(spellScaleInt[spellID]){
					AddStatAmount('int',amount,amount+overheal,cV.intellect,amount,spellID,event.timestamp);
				}
				
				if(event.hitType == 2){
					pV.critNow = cV.critSpell;
					pV.critAmount = amount / (cV.gearInfo[142170] ? (2.05 / 1.05) : 2);
					var critAmountOh = (amount + overheal) / (cV.gearInfo[142170] ? (2.05 / 1.05) : 2);
					
					Object.keys(statsBuffs.crit).forEach(function (buffSpellID) {
						if(buffStatus[buffSpellID]) pV.critNow += statsBuffs.crit[buffSpellID];
					});
					
					if(spellID == 1064){	//chain
						pV.critNow += GetTraitRank(1109) * 4 * 400;
					} else if(spellID == 73921){	//healing rain
						pV.critNow += GetTraitRank(1107) * 2 * 400;
					} else if(spellID == 8004 && event.timestamp <= pV.critTidalLoss){	//surge
						pV.critNow += (GetTraitRank(1103) * 4 + 40) * 400;
					}
					
					AddStatAmount('crit',pV.critAmount,critAmountOh,pV.critNow,amount,spellID,event.timestamp);
				}
				
				if(spellScaleMastery[spellID] && (event.resourceActor == 2 || event.targetID == actor_id) && event.hitPoints && event.maxHitPoints){
					var targetHPbeforeHeal = Math.max(event.hitPoints - amount,0) / event.maxHitPoints;
				
					pV.masteryNow = cV.mastery;

					Object.keys(statsBuffs.mastery).forEach(function (buffSpellID) {
						if(buffStatus[buffSpellID]) {
							if(typeof(buffStatus[buffSpellID]) == "number")
								pV.masteryNow += statsBuffs.mastery[buffSpellID] * buffStatus[buffSpellID];
							else
								pV.masteryNow += statsBuffs.mastery[buffSpellID];
						}
					});

					pV.currHealFromMastery = amount * ( 1 - (1 / (1 + ((pV.masteryNow / 133.33) / 100) * (1 - targetHPbeforeHeal))) );
					var currHealFromMasteryOh = (amount + overheal) * ( 1 - (1 / (1 + ((pV.masteryNow / 133.33) / 100) * (1 - targetHPbeforeHeal))) );
				
					AddStatAmount('mastery',pV.currHealFromMastery,currHealFromMasteryOh,pV.masteryNow,amount,spellID,event.timestamp);
					
					if(targetHPbeforeHeal < 0.30) healPerStat.mastery.b30 += pV.currHealFromMastery; else
					if(targetHPbeforeHeal < 0.40) healPerStat.mastery.b40 += pV.currHealFromMastery; else
					if(targetHPbeforeHeal < 0.50) healPerStat.mastery.b50 += pV.currHealFromMastery; else
					if(targetHPbeforeHeal < 0.60) healPerStat.mastery.b60 += pV.currHealFromMastery; else
					if(targetHPbeforeHeal < 0.70) healPerStat.mastery.b70 += pV.currHealFromMastery; else
					if(targetHPbeforeHeal < 0.80) healPerStat.mastery.b80 += pV.currHealFromMastery; else
								      healPerStat.mastery.b100+= pV.currHealFromMastery;

					if(!healPerStat.mastery.t[event.targetID]) healPerStat.mastery.t[event.targetID] = {
						hp: 0,
						amount: 0,
						mamount: 0,
						spells: {},
					}
					healPerStat.mastery.t[event.targetID].hp += (amount - pV.currHealFromMastery) * (1 - targetHPbeforeHeal);
					healPerStat.mastery.t[event.targetID].amount += (amount - pV.currHealFromMastery);
					healPerStat.mastery.t[event.targetID].mamount += pV.currHealFromMastery;
					healPerStat.mastery.t[event.targetID].spells[spellID] = (healPerStat.mastery.t[event.targetID].spells[spellID] || 0) + pV.currHealFromMastery;
				}			

				if(spellScaleVers[spellID]){
					pV.versNow = cV.versatility;
					Object.keys(statsBuffs.vers).forEach(function (buffSpellID) {
						if(buffStatus[buffSpellID]) pV.versNow += statsBuffs.vers[buffSpellID];
					});
					
					pV.currHealFromVers = amount * ( 1 - (1 / ((pV.versNow / 475) / 100 + 1)) );
					var currHealFromVersOh = (amount + overheal) * ( 1 - (1 / ((pV.versNow / 475) / 100 + 1)) );
					
					AddStatAmount('vers',pV.currHealFromVers,currHealFromVersOh,pV.versNow,amount,spellID,event.timestamp);
				}
				
				if(!spellNotScaleHaste[spellID] && (event.tick || spellAffectedByHaste[spellID])){
					pV.hasteNow = cV.haste;
					Object.keys(statsBuffs.haste).forEach(function (buffSpellID) {
						if(buffStatus[buffSpellID]) {
							if(typeof(buffStatus[buffSpellID]) == "number")
								pV.hasteNow += statsBuffs.haste[buffSpellID] * buffStatus[buffSpellID];
							else
								pV.hasteNow += statsBuffs.haste[buffSpellID];
						}
					});
					
					var hasteMod = (pV.hasteNow / 375 / 100) + 1;
					Object.keys(statsBuffs.haste_mod).forEach(function (buffSpellID) {
						if(buffStatus[buffSpellID]) hasteMod *= statsBuffs.haste_mod[buffSpellID];
					});
					
					pV.currHealFromHaste = (1 - (1 / hasteMod)) * amount;
					var currHealFromHasteOh = (1 - (1 / hasteMod)) * (amount + overheal);
					
					pV.hasteNow = (hasteMod - 1) * 100 * 375;
					
					AddStatAmount('haste',pV.currHealFromHaste,currHealFromHasteOh,pV.hasteNow,amount,spellID,event.timestamp);

					Object.keys(statsBuffs.haste_mod).forEach(function (buffSpellID) {
						if(buffStatus[buffSpellID]){
							if(!rV.buffs.haste_mod[buffSpellID]) rV.buffs.haste_mod[buffSpellID] = 0;
							rV.buffs.haste_mod[buffSpellID] += ((statsBuffs.haste_mod[buffSpellID] - 1) * 100 * 375) / pV.hasteNow * pV.currHealFromHaste;
						}
					});
				}
				
				for (var j = 0, j_len = delayedSpells.length; j < j_len; j++) {
					var CDdata = pV[ delayedSpells[j][0] ];
					if(CDdata && !delayedSpells[j][2][spellID] && event.timestamp <= CDdata.time){
						CDdata.feed += (amount+overheal);
						CDdata.spellsfeed[spellID] = (CDdata.spellsfeed[spellID] || 0) + (amount+overheal);
					}
				}
				
				for (var j = 0, j_len = cooldownsTracking.length; j < j_len; j++) {
					if(cooldownsTracking[j].opened || (cooldownsTracking[j].spellID == 157153 && spellID == 157503 && (event["timestamp"] - cooldownsTracking[j].start) <= 20000)){
						cooldownsTracking[j].healing += amount;

						var currTime = event["timestamp"] - cooldownsTracking[j].start;
						var pos = -1;
						for (var k = 0, k_len = cooldownsTracking[j].heal.length; k < k_len; k++) {
							if(currTime == cooldownsTracking[j].heal[k].time && spellID == cooldownsTracking[j].heal[k].id){
								pos = k;
								break;
							}else if(currTime > cooldownsTracking[j].heal[k].time && spellID == cooldownsTracking[j].heal[k].id && ((currTime - cooldownsTracking[j].heal[k].time) <= 200)){
								pos = k;
								break;
							}
						}
						
						if(pos == -1){
							cooldownsTracking[j].heal.push({
								time: currTime,
								id: spellID,
								amount: 0,
								over: 0,
								count: 0,
							});
							pos = cooldownsTracking[j].heal.length - 1;
						}
						
						cooldownsTracking[j].heal[pos].amount += event["amount"];
						if(event["overheal"]) cooldownsTracking[j].heal[pos].over += event["overheal"];
						cooldownsTracking[j].heal[pos].count ++;
						
						if(spellID == 157503 && cooldownsTracking[j].spellID == 157153){
							cooldownsTracking[j].ended = event["timestamp"];
							cooldownsTracking[j].opened = false;
						}
					}
				}
				
				if(spellID == 98021){		//slt
					for (var j = 0, j_len = sltTracking.length; j < j_len; j++) {
						if((event["timestamp"] - sltTracking[j].start) < 8000){
							var currTime = event["timestamp"] - sltTracking[j].start;
							var pos = -1;
							for (var k = 0, k_len = sltTracking[j].heal.length; k < k_len; k++) {
								if(currTime == sltTracking[j].heal[k].time){
									pos = k;
									break;
								}else if(currTime > sltTracking[j].heal[k].time && ((currTime - sltTracking[j].heal[k].time) <= 500)){
									currTime = sltTracking[j].heal[k].time;
									pos = k;
									break;
								}
							}
							
							if(pos == -1){
								sltTracking[j].heal.push({
									time: currTime,
									data: [],
								});
								pos = sltTracking[j].heal.length - 1;
							}
							
							if(!sltTracking[j].heal[pos].data[event.targetID]){
								sltTracking[j].heal[pos].data[event.targetID] = {
									amount: 0,
									absorbed: 0,
								};
							}
							
							sltTracking[j].heal[pos].data[event.targetID].amount += event["amount"];
							if(event["absorbed"]) sltTracking[j].heal[pos].data[event.targetID].absorbed += event["absorbed"];
							
							sltTracking[j].ended = event["timestamp"];
						}
					}
				}
				
				for (var j = 0, j_len = parsePlugins.heal.length; j < j_len; j++) {
					parsePlugins.heal[j](event,spellID,amount,overheal);
				}			
			} else if(event.type == "summon" && actors[event.sourceID]){
				actors[event.targetID] = true;
			} else if(event.type == "applybuff" && actors[event.targetID]){
				var spellID = event.ability.guid;
				
				if(statsBuffs['vers'][spellID] || statsBuffs['crit'][spellID] || statsBuffs['haste'][spellID] || statsBuffs['haste_mod'][spellID] || statsBuffs['mastery'][spellID] || statsBuffs['int'][spellID]) {		//stats buffs
					buffStatus[spellID] = true;
				}
				if(spellID == 29166){
					pV.innervate = true;
				}

				if(cooldownsTrackingIDs[spellID]) {
					cooldownsTracking.push({
						opened: true,
						spellID: spellID,
						start: event["timestamp"],
						spells: [],
						mana: 0,
						heal: [],
						healing: 0,
					});
				}

				for (var j = 0, j_len = parsePlugins.applybuff.length; j < j_len; j++) {
					parsePlugins.applybuff[j](event,spellID);
				}				
			} else if(event.type == "applybuffstack" && actors[event.targetID]){
				var spellID = event.ability.guid;
				
				if(statsBuffs['vers'][spellID] || statsBuffs['crit'][spellID] || statsBuffs['haste'][spellID] || statsBuffs['haste_mod'][spellID] || statsBuffs['mastery'][spellID] || statsBuffs['int'][spellID]) {		//stats buffs
					buffStatus[spellID] = event.stack;
				}				

				for (var j = 0, j_len = parsePlugins.applybuffstack.length; j < j_len; j++) {
					parsePlugins.applybuffstack[j](event,spellID);
				}
			} else if(event.type == "removebuff" && actors[event.targetID]){
				var spellID = event.ability.guid;
				
				if(statsBuffs['vers'][spellID] || statsBuffs['crit'][spellID] || statsBuffs['haste'][spellID] || statsBuffs['haste_mod'][spellID] || statsBuffs['mastery'][spellID] || statsBuffs['int'][spellID]) {		//stats buffs
					buffStatus[spellID] = false;
				}
				if(spellID == 29166){
					pV.innervate = false;
				} else if(spellID == 53390) {
					pV.critTidalLoss = event.timestamp + 500;
				}

				if(cooldownsTrackingIDs[spellID]) {
					for (var j = 0, j_len = cooldownsTracking.length; j < j_len; j++) {
						if(cooldownsTracking[j].opened && cooldownsTracking[j].spellID == spellID){
							cooldownsTracking[j].ended = event["timestamp"];
							cooldownsTracking[j].opened = false;
						}
					}
				}

				for (var j = 0, j_len = parsePlugins.removebuff.length; j < j_len; j++) {
					parsePlugins.removebuff[j](event,spellID);
				}
			} else if(event.type == "removebuffstack" && actors[event.targetID]){
				var spellID = event.ability.guid;
				
				if(statsBuffs['vers'][spellID] || statsBuffs['crit'][spellID] || statsBuffs['haste'][spellID] || statsBuffs['haste_mod'][spellID] || statsBuffs['mastery'][spellID] || statsBuffs['int'][spellID]) {		//stats buffs
					buffStatus[spellID] = event.stack;
				}				
				if(spellID == 53390) {
					pV.critTidalLoss = event.timestamp + 500;
				}

				for (var j = 0, j_len = parsePlugins.removebuffstack.length; j < j_len; j++) {
					parsePlugins.removebuffstack[j](event,spellID);
				}
			} else if(event.type == "begincast" && actors[event.sourceID]){
				var spellID = event.ability.guid;
				
				for (var j = 0, j_len = parsePlugins.begincast.length; j < j_len; j++) {
					parsePlugins.begincast[j](event,spellID);
				}									
			} else if(event.type == "cast" && actors[event.sourceID]){
				var spellID = event.ability.guid;

				if(cooldownsTrackingIDsbyCast[spellID]) {
					cooldownsTracking.push({
						opened: true,
						spellID: spellID,
						start: event["timestamp"],
						end_limit: event["timestamp"] + cooldownsTrackingIDsbyCast[spellID],
						spells: [],
						mana: 0,
						heal: [],
						healing: 0,
					});
				}
				
				if(spellManaCost[spellID] && !pV.innervate){
					rV.manaUsage += spellManaCost[spellID];
					
					rV.manaUsageBySpell[spellID] = (rV.manaUsageBySpell[spellID] || 0) + spellManaCost[spellID];
					pV.manaUsageLastSpell = spellID;
	
					for (var j = 0, j_len = cooldownsTracking.length; j < j_len; j++) {
						if(cooldownsTracking[j].opened){
							cooldownsTracking[j].mana += spellManaCost[spellID];
						}
					}
				}

				for (var j = 0, j_len = cooldownsTracking.length; j < j_len; j++) {
					if(cooldownsTracking[j].opened && !ignoredSpellsForCDTracking[spellID]){
						cooldownsTracking[j].spells.push({
							spell: spellID,
							time: event["timestamp"] - cooldownsTracking[j].start,
						});
					}
				}	
				
				if(spellID == 201764){	//manual return CBT
					for (var j = 0, j_len = cooldownsTracking.length; j < j_len; j++) {
						if(cooldownsTracking[j].opened && cooldownsTracking[j].spellID == 157153){
							cooldownsTracking[j]['ended'] = event["timestamp"];
							cooldownsTracking[j]['opened'] = false;
						}
					}
				} else if (spellID == 98008){	//slt
					sltTracking.push({
						start: event["timestamp"],
						heal: [],
						damage: [],
					});
				}

				for (var j = 0, j_len = parsePlugins.cast.length; j < j_len; j++) {
					parsePlugins.cast[j](event,spellID);
				}			
			} else if(event.type == "damage"){
				var spellID = event.ability.guid;

				if(spellID == 98021){		//slt
					for (var j = 0, j_len = sltTracking.length; j < j_len; j++) {
						if((event["timestamp"] - sltTracking[j].start) < 8000){
							var currTime = event["timestamp"] - sltTracking[j].start;
							var pos = -1;
							for (var k = 0, k_len = sltTracking[j].damage.length; k < k_len; k++) {
								if(currTime == sltTracking[j].damage[k].time){
									pos = k;
									break;
								}else if(currTime > sltTracking[j].damage[k].time && ((currTime - sltTracking[j].damage[k].time) <= 500)){
									currTime = sltTracking[j].damage[k].time;
									pos = k;
									break;
								}
							}
							
							if(pos == -1){
								sltTracking[j].damage.push({
									time: currTime,
									data: [],
								});
								pos = sltTracking[j].damage.length - 1;
							}
							
							if(!sltTracking[j].damage[pos].data[event.targetID]){
								sltTracking[j].damage[pos].data[event.targetID] = {
									amount: 0,
									absorbed: 0,
								};
							}
							
							sltTracking[j].damage[pos].data[event.targetID].amount += event["amount"];
							if(event["absorbed"]) sltTracking[j].damage[pos].data[event.targetID].absorbed += event["absorbed"];
							
							sltTracking[j].ended = event["timestamp"];
						}
					}
				}
				
				for (var j = 0, j_len = parsePlugins.damage.length; j < j_len; j++) {
					parsePlugins.damage[j](event,spellID);
				}
			} else if(event.type == "energize" && event.targetID == actor_id){
				if(event.resourceChangeType==0){
					var spellID = event.ability.guid;
					
					rV.manaGain += event.resourceChange;
					
					for (var j = 0, j_len = parsePlugins.energize.length; j < j_len; j++) {
						parsePlugins.energize[j](event,spellID);
					}				
				}			
			} else if(event.type == "combatantinfo" && event.sourceID == actor_id){

				if(event["specID"] != 264){
					error_msg("Wrong specialization");
					throw new Error("Wrong specialization");
				}
				
				//console.log(event);
				
				for (var k = 0, k_len = event.gear.length; k < k_len; k++) {
					var gearData = event.gear[k];
					gearData.slot = k;
					cV.gearInfo[gearData.id] = gearData;
					
					for (var j = 0, j_len = parsePlugins.gear.length; j < j_len; j++) {
						parsePlugins.gear[j](gearData,gearData.id);
					}
				}
				for (var k = 0, k_len = event.artifact.length; k < k_len; k++) {
					var traitData = event.artifact[k];
				
					cV.traitInfo[traitData.traitID] = traitData;
					cV.traitBySpell[traitData.spellID] = traitData;
				}
				for (var k = 0, k_len = event.talents.length; k < k_len; k++) {
					var talentInfo = event.talents[k];
					
					talentInfo.row = k + 1;
					cV.talentInfo[talentInfo.id] = talentInfo;
				}
				
				var vantusRune = 0;
				for (var k = 0, k_len = event.auras.length; k < k_len; k++) {
					var auraData = event.auras[k];
					
					if(vantusRunes[ auraData.ability ]){
						vantusRune = 1500;
					}

					for (var j = 0, j_len = parsePlugins.applybuff.length; j < j_len; j++) {
						parsePlugins.applybuff[j](event,auraData.ability);
					}

				}
				
				cV.critSpell = event["critSpell"] + 2000;
				cV.intellect = event["intellect"];
				cV.intellect_min = cV.intellect;
				cV.versatility = event["versatilityHealingDone"] + vantusRune;
				cV.mastery = event["mastery"] + 3200;
				cV.haste = event["hasteSpell"];
				
				cV.gcd = 1500 / (cV.haste / 375 / 100 + 1);
				
				cV.combantantInfo = event;
				
				for (var j = 0, j_len = parsePlugins.combantantInfo.length; j < j_len; j++) {
					parsePlugins.combantantInfo[j](event);
				}
			}
			
			for (var j = 0, j_len = cooldownsTracking.length; j < j_len; j++) {
				if(cooldownsTracking[j].opened && cooldownsTracking[j].end_limit && event["timestamp"] >= cooldownsTracking[j].end_limit){
					cooldownsTracking[j]['ended'] = event["timestamp"];
					cooldownsTracking[j]['opened'] = false;
					if(cooldownsTracking[j].spellID == 157153) pV.buffCBTActive = false;	//CBT
				}
			}
			
			if(event.ability && !cV.spellInfo[event.ability.guid]){
				cV.spellInfo[event.ability.guid] = {
					icon: event["ability"]["abilityIcon"],
					name: event["ability"]["name"],
				};
			}			
		}
		
		} catch(err) { error_msg("Error: "+err); throw new Error(err); }
		
		if(!data.nextPageTimestamp) {
			$("#navbar-progress").width("100%").css('opacity', '0');
			if(pV.ReUpdatePage) clearTimeout(pV.ReUpdatePage);
			BuildReport();
		} else {
			currFightData.end_time_parsed = data.nextPageTimestamp;
			if(!pV.ReUpdatePage) pV.ReUpdatePage = setTimeout(function() {  BuildReportMinor(); pV.ReUpdatePage = false; },300);
			var prog = (data.nextPageTimestamp - currFightData.start_time) / (currFightData.end_time - currFightData.start_time) * 100;
			$("#navbar-progress").width(prog+"%").css('opacity', '1');
			ParseLog(fight_code,actor_id,data.nextPageTimestamp,end_time);
		}
		
	}).fail( function( data ) {
		error_msg("Parsing Error. Log may be private or removed.");
		throw new Error("Error: Parsing Error");
	});
}

function ParseHeader(fight_code,showPage,afterFunc)
{
	$.getJSON( "https://www.warcraftlogs.com:443/v1/report/fights/"+fight_code+"?api_key="+WCL_API_KEY ).done( function( data ) {
		if(data.status == 400){
			error_msg(data.error);
			throw new Error("Error: Parsing Error");
		}
		
		fightsData = [];
		actorsData = [];
		
		for (var i = 0, len = data.fights.length; i < len; i++) {
			var obj = data.fights[i];
			obj.actors = [];
			fightsData[obj.id] = obj;
		}

		var grabUnitsList = [data.friendlies,data.enemies,data.friendlyPets,data.enemyPets];
		for (var i = 0, len = grabUnitsList.length; i < len; i++) {
			var obj = grabUnitsList[i]
			for (var j = 0, j_len = obj.length; j < j_len; j++) {
				var unit = obj[j]
				actorsData[unit.id] = {
					name: unit.name,
					class: unit.type,
				}
				for (var k = 0, k_len = unit.fights.length; k < k_len; k++) {
					if(fightsData[ unit.fights[k].id ]){
						fightsData[ unit.fights[k].id ].actors.push(unit.id);
					}
				}
			}
		}
		
		currFightData.report_name = data.title;
		
		if(showPage) BuildFightsList();
		if(afterFunc) afterFunc();
	}).fail( function( data ) {
		error_msg("Parsing Error. Log may be private or removed.");
		throw new Error("Error: Parsing Error");
	});
}

function CalcHealingFromItem(itemID,diffStats)
{
	var passiveStats = 0;
	var statsText = "Calculated stats:";
	var obj = cV.gearInfo[itemID];
	var defStats = false;
	if(obj){
		var statsDB = diffStats || itemsStats[itemID];
		if(statsDB){
			var realIlvl = obj.itemLevel;
			var baseIlvl = statsDB['ilvl'];
			
			Object.keys(statsDB).forEach(function (statName) {
				var value = statsDB[statName]
				if(statName == 'passive' && obj.bonusIDs){
					for (var i = 0, i_len = obj.bonusIDs.length; i < i_len; i++) {
						if(itemsBonusToStats[ obj.bonusIDs[i] ]){
							statName = itemsBonusToStats[ obj.bonusIDs[i] ];
							break;
						}
					}
				}
			
				if(healPerStat[statName]){
					var newValue = ScaleStat(value,baseIlvl,realIlvl,statName == "int" ? 1 : (jewelSlots[ obj.slot ] ? 2 : 0));
					statsText += "<br>"+statName+": "+Math.round(newValue);
					if(statName == "int") newValue *= 1.05;	//5% bonus
					passiveStats += healPerStat[statName].amount * newValue;
				}
			});
			defStats = true;
		}
		
		if(obj.gems) {
			for (var i = 0, i_len = obj.gems.length; i < i_len; i++) {
				var gemItemID = obj.gems[i].id
				if(gemToStat[gemItemID]){
					var gemStatData = gemToStat[gemItemID];
					if(healPerStat[ gemStatData[0] ]){
						statsText += "<br>Gem "+gemStatData[0]+": "+Math.round(gemStatData[1]);
					
						passiveStats += healPerStat[ gemStatData[0] ].amount * gemStatData[1] * (gemStatData[0] == "int" ? 1.05 : 1);
					}
				}
			}
		}
		if(obj.permanentEnchant && enchToStat[ obj.permanentEnchant ])  {
			var gemStatData = enchToStat[ obj.permanentEnchant ];
			if(healPerStat[ gemStatData[0] ]){
				statsText += "<br>Enchant "+gemStatData[0]+": "+Math.round(gemStatData[1]);
			
				passiveStats += healPerStat[ gemStatData[0] ].amount * gemStatData[1] * (gemStatData[0] == "int" ? 1.05 : 1);
			}
		}
	}
	
	return {
		heal: passiveStats,
		tip: statsText,
		base: defStats,
	};
}

var IsWowheadResponceRewritten = false;

function GetItemDataFromWowhead(itemID)
{
	if(!IsWowheadResponceRewritten){
		if(!$WowheadPower || !$WowheadPower.registerItem) return false;
		$WowheadPower.registerItem = function(id,locale,json){
			if(json && json.tooltip_enus){
				var itemID = id.match(/^(\d+)/)[1];
				
				var itemStatus = $("#gear-"+itemID+"-text").attr("data-status");

				var itemStats = {};
				
				var matches = json.tooltip_enus.match(/ilvl-->(\d+)/);
				if(matches) itemStats.ilvl = matches[1].replace(",", "");

				var matches = json.tooltip_enus.match(/nstart--><b class=\"[^\"]*\">([^<]*)/);
				if(matches) itemStats.name = matches[1];

				var matches = json.tooltip_enus.match(/-->\+([\d,]+) (\[Agility or Intellect\]|Intellect|\[Agility or Strength or Intellect\])/);
				if(matches) itemStats.int = matches[1].replace(",", "");

				var matches = json.tooltip_enus.match(/([\d,]+) Critical Strike/);
				if(matches) itemStats.crit = matches[1].replace(",", "");

				var matches = json.tooltip_enus.match(/([\d,]+) Mastery/);
				if(matches) itemStats.mastery = matches[1].replace(",", "");

				var matches = json.tooltip_enus.match(/([\d,]+) Versatility/);
				if(matches) itemStats.vers = matches[1].replace(",", "");

				var matches = json.tooltip_enus.match(/([\d,]+) Haste/);
				if(matches) itemStats.haste = matches[1].replace(",", "");
				
				var passiveStats = CalcHealingFromItem(itemID,itemStats);
				//console.log(itemStats.name,itemStats,passiveStats);
				
				var ilvlName = $("#gear-"+itemID+"-name").attr("data-ilvl");
				$("#gear-"+itemID+"-name").html(itemStats.name+" "+ilvlName);
				if(itemStatus!="locked"){
					$("#gear-"+itemID+"-text").attr("data-status","locked");
					
					var HTML = "";
					if(passiveStats.heal > 0){
						HTML += "From <em class=\"tooltip\">passive stats<span class=\"tip-text\" style=\"width: 120px;margin-left:-60px;\">"+passiveStats.tip+"</span></em>: "+NumberToFormattedNumber(passiveStats.heal,2)+" ("+(passiveStats.heal/rV.total*100).toFixed(2)+"%)<br>";
					}
					if(passiveStats.heal > 0) HTML += "HPS: <em class=\"result-hps\">"+NumberToFormattedNumber(passiveStats.heal / currFightData.len * 1000,1)+"</em>";
					
					$("#gear-"+itemID+"-text").html(HTML);
				}
				
			}
			$WowheadPower.register(3,id,locale,json);
		}
		IsWowheadResponceRewritten = true;
	}
	
	$.ajaxSetup({cache: true});
	$.getScript( "https://www.wowhead.com/item="+itemID+"&power" );	
}

Number.prototype.format = function() {
	return this.toLocaleString(undefined, {maximumFractionDigits:0,useGrouping:true}).replace(/\D/g,",");
};

function BuildReportMinor(){
	var HTML = "";
	
	console.log('BuildReportMinor',new Date().getTime());

	var fightLen = (currFightData.end_time_parsed || currFightData.end_time) - currFightData.start_time;

	var currTotal = 0;
	Object.keys(healingData).forEach(function (spellID) {
		if(spellID != 98021) currTotal += healingData[spellID][0];
	});

	HTML += "<div class=\"panel\" style=\"margin-top:-10px;\"><div class=\"row full\" style=\"margin-bottom:5px;\">";
	var hps = Math.round(currTotal / fightLen * 1000);
	HTML += "<div class=\"col\"><div class=\"box small-box clearfix\"><div class=\"row\"><div class=\"col w25\"><img src=\"http://media.blizzard.com/wow/icons/56/spell_nature_healingwavegreater.jpg\"></div><div class=\"col w75\">Healing Done: "+NumberToFormattedNumber(currTotal)+"<br>HPS: "+NumberToFormattedNumber(hps,0,3)+"</div></div></div></div>";
	HTML += "<div class=\"col\"><div class=\"box small-box clearfix\"><div class=\"row\"><div class=\"col w25\"><img src=\"http://media.blizzard.com/wow/icons/56/spell_nature_healingtouch.jpg\"></div><div class=\"col w75\">Mastery healing Done:<br>"+NumberToFormattedNumber(Math.round(healPerStat.mastery.total),1)+" ("+Math.round(healPerStat.mastery.total / healPerStat.mastery.all * 100)+"%)</div></div></div></div>";
	HTML += "</div></div>";	
	
	HTML += "<div class=\"panel\">";
	/// Spells List
	var spellslistKeys = Object.keys(healingData);
	spellslistKeys.sort(function(a,b){ return healingData[a][0] > healingData[b][0] ? - 1 : 1 });
	HTML += "<div class=\"col-half\"><div class=\"box clearfix spellslist\">";
	for (var j = 0, j_len = spellslistKeys.length; j < j_len; j++) {
		var spellID = spellslistKeys[j];
		var spellInfo = cV.spellInfo[spellID];
		HTML += "<div class=\"row full\"><div class=\"line half\"><a href=\"//www.wowhead.com/spell="+spellID+"\" target=\"_blank\"><img src=\"http://media.blizzard.com/wow/icons/56/"+spellInfo['icon']+"\" alt=\""+spellInfo['name']+"\">"+spellInfo['name']+"</a></div><div class=\"line t-right w15\">"+NumberToFormattedNumber(healingData[spellID][0],1)+"</div><div class=\"line t-right t-grey w15\">"+NumberToFormattedNumber(healingData[spellID][1],1)+"</div></div>";
	}
	HTML += "</div></div>";	

	
	$("#main").html(HTML);
}


function BuildReport(){
	if(!cV.combantantInfo){
		error_msg("Error: Combantant info is missing. Logs must be written with enabled 'Advanced combat logging' option");
		throw new Error("Error: Combantant info is missing.");
	}
	
	rV.total = 0;
	Object.keys(healingData).forEach(function (spellID) {
		if(spellID != 98021) rV.total += healingData[spellID][0];
	});

	for (var k = 0, k_len = pluginsList.length; k < k_len; k++) {
		var pluginData = pluginsList[k];
		for (var i = 0, len = pluginData.length; i < len; i++) {
			if(pluginData[i].afterParse) pluginData[i].afterParse();
		}
	}
	
	
	//console.log(healingData);
	console.log(rV);
	//console.log(healPerStat);
	
	var HTML = "";
	
	var fightStart = currFightData.start_time;
	var fightEnd = currFightData.end_time;
	var fightLen = fightEnd - fightStart;
	
	HTML += "<div class=\"panel\" style=\"margin-top:-10px;\"><div class=\"row full\" style=\"margin-bottom:5px;\">";
	var hps = Math.round(rV.total / fightLen * 1000);
	HTML += "<div class=\"col\"><div class=\"box small-box clearfix\"><div class=\"row\"><div class=\"col w25\"><img src=\"http://media.blizzard.com/wow/icons/56/spell_nature_healingwavegreater.jpg\"></div><div class=\"col w75\">Healing Done: "+NumberToFormattedNumber(rV.total)+"<br>HPS: "+NumberToFormattedNumber(hps,0,3)+"</div></div></div></div>";
	HTML += "<div class=\"col\"><div class=\"box small-box clearfix\"><div class=\"row\"><div class=\"col w25\"><img src=\"http://media.blizzard.com/wow/icons/56/spell_nature_healingtouch.jpg\"></div><div class=\"col w75\">Mastery healing Done:<br>"+NumberToFormattedNumber(Math.round(healPerStat.mastery.total),1)+" ("+Math.round(healPerStat.mastery.total / healPerStat.mastery.all * 100)+"%)</div></div></div></div>";
	HTML += "<div class=\"col\"><div class=\"box small-box clearfix\"><div class=\"row\"><div class=\"col w25\"><img style=\"filter: grayscale(100%);-webkit-filter: grayscale(100%);\" src=\"http://media.blizzard.com/wow/icons/56/spell_shaman_tidalwaves.jpg\"></div><div class=\"col w75\">HW or Surge without tidal:<br>"+rV.hwWithoutTidal+" ("+Math.round(rV.hwWithoutTidal / rV.hwWithoutTidalTotal * 100)+"%)</div></div></div></div>";
	HTML += "<div class=\"col\"><div class=\"box small-box clearfix\"><div class=\"row\"><div class=\"col w25\"><img src=\"http://media.blizzard.com/wow/icons/56/spell_shaman_spiritwalkersgrace.jpg\"></div><div class=\"col w75\">Spiritwalker's uptime:<br>"+Math.round(rV.spiritwalkerUptime/1000)+"s ("+Math.round(rV.spiritwalkerUptime / fightLen * 100)+"%)</div></div></div></div>";
	HTML += "<div class=\"col\"><div class=\"box small-box clearfix\"><div class=\"row\"><div class=\"col w25\"><img src=\"http://media.blizzard.com/wow/icons/56/spell_nature_spiritwolf.jpg\"></div><div class=\"col w75\">Wolf uptime:<br>"+Math.round(rV.wolfUptime/1000)+"s ("+Math.round(rV.wolfUptime / fightLen * 100)+"%)</div></div></div></div>";
	HTML += "</div></div>";	
	
	
	
	HTML += "<div class=\"panel\">";
	
	/// Spells List
	var spellslistKeys = Object.keys(healingData);
	spellslistKeys.sort(function(a,b){ return healingData[a][0] > healingData[b][0] ? - 1 : 1 });
	HTML += "<div class=\"col-half\"><div class=\"box clearfix spellslist\">";
	for (var j = 0, j_len = spellslistKeys.length; j < j_len; j++) {
		var spellID = spellslistKeys[j];
		var spellInfo = cV.spellInfo[spellID];
		HTML += "<div class=\"row full\"><div class=\"line half\"><a href=\"//www.wowhead.com/spell="+spellID+"\" target=\"_blank\"><img src=\"http://media.blizzard.com/wow/icons/56/"+spellInfo['icon'].replace(/\-/,"")+"\" alt=\""+spellInfo['name']+"\">"+spellInfo['name']+"</a></div><div class=\"line t-right w15\">"+NumberToFormattedNumber(healingData[spellID][0],1)+"</div><div class=\"line t-right t-grey w15\">"+NumberToFormattedNumber(healingData[spellID][1],1)+"</div></div>";
	}
	HTML += "</div></div>";	
	
	/// Stats List
	HTML += "<div class=\"col-half\"><div class=\"box clearfix statlist\"><header class=\"box-header\" style=\"padding-bottom:0;padding-top:0\">Stats</header>";
	var allStatsList = [
		["int","Int","From gear: "+cV.intellect_min],
		["crit","Crit","From gear: "+(cV.critSpell-2000)+"<br>Base value: 2000<br>Avg number can be much higher due Floodwaters & Empowered Droplets traits and Tidal Waves buff"],
		["mastery","Mastery","From gear: "+(cV.mastery-3200)+"<br>Base value: 3200"],
		["vers","Vers","From gear: "+cV.versatility],
		["haste","<em class=\"tooltip\">Haste<span class=\"tip-text\" style=\"width: 300px;margin-left:-150px;\">Cast time not counted here, only profit from ticks</span></em>","From gear: "+cV.haste],
	];
	HTML += "<div class=\"row full\"><div class=\"col size\"> </div><div class=\"col size\">Heal per stat</div><div class=\"col size\">Stat weight</div><div class=\"col size\">Total from stat</div><div class=\"col size\">Avg on fight</div></div>";
	for (var j = 0, j_len = allStatsList.length; j < j_len; j++) {
		var statData = allStatsList[j];
		var amount = healPerStat[ statData[0] ].amount;
		var total = healPerStat[ statData[0] ].total;
		var amountText = amount.toFixed(3);
		var totalText = NumberToFormattedNumber(total);
		var weightText = (amount / fightLen * 1000).toFixed(2);
		if(statData[0] == "crit" && rV.resurgenceCritAmount > 0){
			var regurgenceAmount = rV.resurgenceCrit / rV.manaUsage * rV.healFromMana;
			var preTotal = total;
			total += regurgenceAmount;
			var preAmount = amount;
			amount += regurgenceAmount / rV.resurgenceCritAmount;
			amountText = "<em class=\"tooltip\">"+amount.toFixed(3)+"<span class=\"tip-text\" style=\"width: 200px;margin-left:-100px;\">From crit heals: "+preAmount.toFixed(3)+"<br>From resurgence: "+(regurgenceAmount / rV.resurgenceCritAmount).toFixed(3)+"</span></em>";
			totalText = "<em class=\"tooltip\">"+NumberToFormattedNumber(total)+"<span class=\"tip-text\" style=\"width: 200px;margin-left:-100px;\">From crit heals: "+NumberToFormattedNumber(preTotal)+"<br>From resurgence: "+NumberToFormattedNumber(regurgenceAmount)+"</span></em>";			
			weightText = "<em class=\"tooltip\">"+(amount / fightLen * 1000).toFixed(2)+"<span class=\"tip-text\" style=\"width: 200px;margin-left:-100px;\">From crit heals: "+(preAmount / fightLen * 1000).toFixed(2)+"<br>From resurgence: "+(regurgenceAmount / rV.resurgenceCritAmount / fightLen * 1000).toFixed(2)+"</span></em>";
 		} else if(statData[0] == "int") {
			weightText = "<em class=\"tooltip\">"+(amount / fightLen * 1000 * 1.05).toFixed(2)+"<span class=\"tip-text\" style=\"width: 200px;margin-left:-100px;\">5% armor bonus included</span></em>";
		} else if(statData[0] == "mastery") {
			totalText = "<em class=\"tooltip\">"+NumberToFormattedNumber(total)+"<span class=\"tip-text\" style=\"width: 200px;margin-left:-100px;\">Based on health %:<br>";
			totalText += "100-80: "+NumberToFormattedNumber(healPerStat.mastery.b100,0,1)+"<br>";
			totalText += "80-70: "+NumberToFormattedNumber(healPerStat.mastery.b80,0,1)+"<br>";
			totalText += "70-60: "+NumberToFormattedNumber(healPerStat.mastery.b70,0,1)+"<br>";
			totalText += "60-50: "+NumberToFormattedNumber(healPerStat.mastery.b60,0,1)+"<br>";
			totalText += "50-40: "+NumberToFormattedNumber(healPerStat.mastery.b50,0,1)+"<br>";
			totalText += "40-30: "+NumberToFormattedNumber(healPerStat.mastery.b40,0,1)+"<br>";
			totalText += "30-0: "+NumberToFormattedNumber(healPerStat.mastery.b30,0,1)+"</span></em>";
		}
		
		var subSpellsList = "";
		if(healPerStat[ statData[0] ].spells){
			subSpellsList = " <em class=\"tooltip\">[?]<span class=\"tip-text\" style=\"width: 300px;margin-left:-150px;\">";
			var spellsKeys = Object.keys(healPerStat[ statData[0] ].spells);
			spellsKeys.sort(function(a,b){ return healPerStat[ statData[0] ].spells[ a ] > healPerStat[ statData[0] ].spells[ b ] ? -1 : 1 });
			for (var k = 0, k_len = spellsKeys.length; k < k_len; k++) {
				var spellID = spellsKeys[k];
				var icon = cV.spellInfo[spellID] ? cV.spellInfo[spellID].icon : "";
				var name = cV.spellInfo[spellID] ? cV.spellInfo[spellID].name : "";
				subSpellsList += "<img src=\"http://media.blizzard.com/wow/icons/56/"+icon+"\" alt=\""+name+"\"> "+name+" - "+healPerStat[ statData[0] ].spells[spellID].toFixed(1)+"<br>";

			}
			subSpellsList += "</span></em>"
		};
		
		HTML += "<div class=\"row full\"><div class=\"col size\">"+statData[1]+"</div><div class=\"col size\">"+amountText+subSpellsList+"</div><div class=\"col size\">"+weightText+"</div><div class=\"col size\">"+totalText+"</div><div class=\"col size\"><em class=\"tooltip\">"+(healPerStat[ statData[0] ].avg / healPerStat[ statData[0] ].avgCount).format()+"<span class=\"tip-text\" style=\"width: "+(statData[0] == "crit" ? 300 : 120)+"px;margin-left:-"+(statData[0] == "crit" ? 150 : 60)+"px;\">"+statData[2]+"</span></em></div></div>";
	}
	
	
	var manaSpellsText = "<br>Mana used by spells:";
	var manaSpellsKeys = Object.keys(rV.manaUsageBySpell);
	manaSpellsKeys.sort(function(a,b){ return rV.manaUsageBySpell[a] > rV.manaUsageBySpell[b] ? -1 : 1 });
	for (var k = 0, k_len = manaSpellsKeys.length; k < k_len; k++) {
		var spellID = manaSpellsKeys[k];
		var icon = cV.spellInfo[spellID] ? cV.spellInfo[spellID].icon : "";
		var name = cV.spellInfo[spellID] ? cV.spellInfo[spellID].name : "";
		manaSpellsText += "<br><img src=\"http://media.blizzard.com/wow/icons/56/"+icon+"\" alt=\""+name+"\"> "+name+" - "+NumberToFormattedNumber(rV.manaUsageBySpell[spellID],0,2);	
	}
	HTML += "<div class=\"row full\"><div class=\"col size\">Mana</div><div class=\"col size\"><em class=\"tooltip\">"+(rV.healFromMana / rV.manaUsage * 1000).toFixed(2)+"<span class=\"tip-text\" style=\"width: 200px;margin-left:-100px;\">Healing per 1000 mana points</span></em></div><div class=\"col size\"> </div><div class=\"col size\">"+NumberToFormattedNumber(rV.healFromMana)+"</div><div class=\"col size\"><em class=\"tooltip\">"+(rV.manaUsage).format()+"<span class=\"tip-text\" style=\"width: 350px;margin-left:-175px;\">Mana used on fight: "+(rV.manaUsage).format()+"<br>Mana gained via passives & buffs: "+(rV.manaGain).format()+"<br>Mana regened: "+(fightLen / 1000 * 8800).format()+"<br>Base manapull: "+(1100000).format()+manaSpellsText+"</span></em></div></div>";

	HTML += "<div class=\"row full\"><div class=\"col full\" id=\"stats_graph_more\"><a href=\"javascript:void(0)\" class=\"more_graph\">Show graph</a></div><div class=\"ct-chart\" style=\"display:none\"  id=\"stats_graph\"></div></div>";	

	HTML += "</div></div>";	

	/// Items predictions
	HTML += "<div class=\"col-half\"><div class=\"box clearfix predictionlist\"><header class=\"box-header\" style=\"padding-bottom:0;padding-top:0\">Items predictions ";
	HTML += "<sup class=\"tooltip\" style=\"font-size: 0.4em\"> [?]<span class=\"tip-text\" style=\"width: 300px;margin-left:-150px;\">Only benefit from \"spell\" part of item is counted here</span></sup></header>";
	for (var i = 0, len = ITEMS.length; i < len; i++) {
		if(ITEMS[i].obj && ITEMS[i].obj.prediction && (!ITEMS[i].obj.predictionСondition || ITEMS[i].obj.predictionСondition()) && (ITEMS[i].obj.type!="item" || (!ITEMS[i].obj.predictionСondition && !cV.gearInfo[ITEMS[i].obj.id]))){
			var itemData = ITEMS[i].obj;
			HTML += "<div class=\"row full\"><div class=\"col s-1\"><a href=\"//www.wowhead.com/"+itemData.type+"="+itemData.id+"\" target=\"_blank\" style=\"color: #"+qualityColors[ itemData.quality ]+";\">"+itemData.name+"</a></div><div class=\"col s-2\">"+NumberToFormattedNumber(rV[ itemData.prediction ],2)+(itemData.text ? (" "+itemData.text()) : "")+"</div><div class=\"col s-2\">"+(rV[ itemData.prediction ]/rV.total*100).toFixed(2)+"%</div></div>";
		}
	}
	HTML += "</div></div>";	
	
	HTML += "</div>";
	
	
	/// Items
	HTML += "<div class=\"panel\"><div class=\"col-full\"><div class=\"box\"><header class=\"box-header\">ITEMS ";
	HTML += "<sup class=\"tooltip\" style=\"font-size: 0.4em\"> [supported items]<span class=\"tip-text\" style=\"width: 400px;margin-left:-200px;\">";
	var counter = false;
	for (var i = 0, len = ITEMS.length; i < len; i++) {
		if(ITEMS[i].obj && ITEMS[i].obj.gear){
			if(counter) HTML += ", ";
			HTML += ITEMS[i].obj.name;
			counter = true;
		}
	}
	HTML += "</span></sup></header><div class=\"list-top-line\"> </div><ul class=\"list special_items\">";
	counter = 0;
	var itemsData = [];
	for (var i = 0, len = ITEMS.length; i < len; i++) {
		var obj = ITEMS[i].obj;
		if(obj && obj.gear && ((!obj.gearFunc && cV.gearInfo[obj.id]) || (obj.gearFunc && obj.gearFunc()))) itemsData.push([ obj.gear,ITEMS[i] ]);
	}
	itemsData.sort(function(a,b){ return rV[ a[0] ] > rV[ b[0] ] ? - 1 : 1 });
	for (var i = 0, len = itemsData.length; i < len; i++) {
		var obj = itemsData[i][1].obj;
		if(obj){
			var itemID = obj.id;
	
			if(counter % 3 == 0) HTML += "<li class=\"item clearfix\">";
			
			HTML += "<div class=\"row w33\"><div class=\"col w70p\">";
			HTML += "<a href=\"//www.wowhead.com/"+obj.type+"="+itemID+((cV.gearInfo[itemID] && cV.gearInfo[itemID].bonusIDs) ? "&bonus="+cV.gearInfo[itemID].bonusIDs.join(":") : "")+"\" target=\"_blank\"><img src=\"http://media.blizzard.com/wow/icons/56/"+(obj.icon || cV.gearInfo[itemID].icon)+"\" alt=\""+obj.name+"\"></a></div>";
	
			HTML += "<div class=\"col div_more_1 w80\"><header style=\"color: #"+qualityColors[obj.quality]+";\">"+obj.name+"</header>";
		
			var amount = rV[obj.gear]
			if(amount > 0) HTML += "<em class=\"result\">"+NumberToFormattedNumber(amount,2)+"</em> ("+(amount/rV.total*100).toFixed(2)+"%)<br>";
			
			var passiveStats = CalcHealingFromItem(itemID)
			passiveStats.heal = 0;	//block passives
			if(passiveStats.heal > 0){
				HTML += "From passive stats: "+NumberToFormattedNumber(passiveStats.heal,2)+" ("+(passiveStats.heal/rV.total*100).toFixed(2)+"%)<br>";
			}
						
			HTML += "HPS: <em class=\"result-hps\">";
			if(amount > 0) HTML += NumberToFormattedNumber(amount / fightLen * 1000,1);
			if(passiveStats.heal > 0) HTML += (amount > 0 ? " / " : "")+NumberToFormattedNumber(passiveStats.heal / fightLen * 1000,1);
			HTML += "</em>";
		
			if(obj.gearAdditionalText) HTML += "<br>"+obj.gearAdditionalText();
		
			HTML += "</div></div>";
			counter++;
		}
	}	
	HTML += "</ul></div></div></div>";
	
	
	/// Gear
	var UpdateFromWowhead = [];
	HTML += "<div class=\"panel\"><div class=\"col-full\"><div class=\"box\"><header class=\"box-header\">GEAR</header><div class=\"list-top-line\"> </div><ul class=\"list gear\">";
	counter = 0;
	for (var i = 0, len = cV.combantantInfo.gear.length; i < len; i++) {
		var gearData = cV.combantantInfo.gear[i]
		if(gearData.id != 0){
			var itemID = gearData.id

			if(counter % 3 == 0) HTML += "<li class=\"item clearfix\">";
			
			HTML += "<div class=\"row w33\" id=\"gear-"+itemID+"\"><div class=\"col w70p\">";
			HTML += "<a href=\"//www.wowhead.com/item="+itemID+(gearData ? (gearData.bonusIDs ? "&bonus="+gearData.bonusIDs.join(":") : "") : "")+"\" target=\"_blank\"><img src=\"http://media.blizzard.com/wow/icons/56/"+gearData.icon.replace(/\-/,"")+"\" alt=\""+gearData.icon+"\"></a></div>";

			HTML += "<div class=\"col div_more_1 w80\"><header style=\"color: #"+qualityColors[gearData.quality]+";\" id=\"gear-"+itemID+"-name\" data-ilvl=\""+gearData.itemLevel+"\">"+gearData.itemLevel+"</header>";
		
			var passiveStats = CalcHealingFromItem(itemID)
			
			HTML += "<div class=\"row-gear full\" id=\"gear-"+itemID+"-text\" data-status=\""+(passiveStats.base ? "locked" : "unlocked")+"\">";
			if(passiveStats.heal > 0){
				HTML += "From <em class=\"tooltip\">passive stats<span class=\"tip-text\" style=\"width: 120px;margin-left:-60px;\">"+passiveStats.tip+"</span></em>: "+NumberToFormattedNumber(passiveStats.heal,2)+" ("+(passiveStats.heal/rV.total*100).toFixed(2)+"%)<br>";
			}
						
			if(passiveStats.heal > 0) HTML += "HPS: <em class=\"result-hps\">"+NumberToFormattedNumber(passiveStats.heal / fightLen * 1000,1)+"</em>";
		
			HTML += "</div></div></div>";
			counter++;
			
			UpdateFromWowhead.push(itemID);
		}
	}	
	HTML += "</ul></div></div></div>";
	
	
	/// Traits
	HTML += "<div class=\"panel\"><div class=\"col-full\"><div class=\"box\"><header class=\"box-header\">TRAITS</header><div class=\"list-top-line\"> </div><ul class=\"list traits\">";
	counter = 0;
	var traitsData = [];
	for (var i = 0, len = TRAITS.length; i < len; i++) if(GetTraitRank(TRAITS[i].obj.id) > 0) traitsData.push([ TRAITS[i].obj.id,TRAITS[i] ]);
	traitsData.sort(function(a,b){ return rV.traits[ a[0] ] > rV.traits[ b[0] ] ? - 1 : 1 });
	for (var i = 0, len = traitsData.length; i < len; i++) {
		var traitData = traitsData[i][1].obj
		var traitRank = GetTraitRank(traitData.id)
		if(traitRank > 0){
			if(counter % 3 == 0) HTML += "<li class=\"item clearfix\">";
			
			HTML += "<div class=\"row w33\"><div class=\"col w70p\">";
			HTML += "<a href=\"//www.wowhead.com/spell="+traitData.spellID+"\" target=\"_blank\"><img src=\"http://media.blizzard.com/wow/icons/56/"+traitData.icon+"\" alt=\""+traitData.name+"\"></a></div>";

			HTML += "<div class=\"col div_more_1 w80\"><header><a href=\"//www.wowhead.com/spell="+traitData.spellID+"\" target=\"_blank\">"+traitData.name+"</a>"+(traitRank > 1 ? " [Rank "+traitRank+"]" : "")+"</header>";
		
			var amount = rV.traits[traitData.id];
			HTML += "<em class=\"result "+(traitData.tip ? "tooltip" : "")+"\">"+NumberToFormattedNumber(amount,2)+(traitData.tip ? "<span class=\"tip-text\" style=\"width: 180px;margin-left:-90px;\">"+traitData.tip()+"</span>" : "")+"</em> ("+(amount/rV.total*100).toFixed(2)+"%)<br>";
			HTML += "HPS: <em class=\"result-hps\">"+NumberToFormattedNumber(amount / fightLen * 1000,1)+"</em>";

			if(traitData.additionalText) HTML += "<br>"+traitData.additionalText();
			else if(traitRank > 1) HTML += "<br>Per rank: "+NumberToFormattedNumber(amount / traitRank,0,2)+" ("+(amount / traitRank/rV.total*100).toFixed(2)+"%)";		
		
			HTML += "</div></div>";
			counter++;
		}
	}	
	HTML += "</ul></div></div></div>";
	
	
	/// NETHERLIGHT
	HTML += "<div class=\"panel\"><div class=\"col-full\"><div class=\"box\"><header class=\"box-header\">NETHERLIGHT CRUCIBLE</header><div class=\"list-top-line\"> </div><ul class=\"list traits\">";
	counter = 0;
	var netherlightData = [];
	for (var i = 0, len = NETHERLIGHT.length; i < len; i++) if(cV.traitBySpell[ NETHERLIGHT[i].obj.spellID ] || NETHERLIGHT[i].obj.spellID == -1) netherlightData.push([ NETHERLIGHT[i].obj.spellID,NETHERLIGHT[i] ]);
	netherlightData.sort(function(a,b){ return rV.netherlight[ a[0] ] > rV.netherlight[ b[0] ] ? - 1 : 1 });
	for (var i = 0, len = netherlightData.length; i < len; i++) {
		var traitData = netherlightData[i][1].obj;
		
		var traitRank = 1;
		if(cV.traitBySpell[traitData.spellID] && cV.traitBySpell[traitData.spellID].rank) traitRank = cV.traitBySpell[traitData.spellID].rank;

		if(counter % 3 == 0) HTML += "<li class=\"item clearfix\">";
		
		HTML += "<div class=\"row w33\"><div class=\"col w70p\">";
		HTML += "<a href=\"//www.wowhead.com/spell="+traitData.spellID+"\" target=\"_blank\"><img src=\"http://media.blizzard.com/wow/icons/56/"+traitData.icon+"\" alt=\""+traitData.name+"\"></a></div>";

		HTML += "<div class=\"col div_more_1 w80\"><header><a href=\"//www.wowhead.com/spell="+traitData.spellID+"\" target=\"_blank\">"+traitData.name+"</a>"+"</header>";
	
		var amount = rV.netherlight[traitData.spellID];
		HTML += "<em class=\"result "+(traitData.tip ? "tooltip" : "")+"\">"+NumberToFormattedNumber(amount,2)+(traitData.tip ? "<span class=\"tip-text\" style=\"width: 180px;margin-left:-90px;\">"+traitData.tip()+"</span>" : "")+"</em> ("+(amount/rV.total*100).toFixed(2)+"%)<br>";
		HTML += "HPS: <em class=\"result-hps\">"+NumberToFormattedNumber(amount / fightLen * 1000,1)+"</em>";

		if(traitData.additionalText) HTML += "<br>"+traitData.additionalText();
		if(traitRank > 1) HTML += "<br>Per rank: "+NumberToFormattedNumber(amount / traitRank,0,2)+" ("+(amount / traitRank/rV.total*100).toFixed(2)+"%)";		
	
		HTML += "</div></div>";
		counter++;
	}	
	HTML += "</ul></div></div></div>";

	/// Talents
	HTML += "<div class=\"panel\"><div class=\"col-full\"><div class=\"box\"><header class=\"box-header\">TALENTS</header><div class=\"list-top-line\"> </div><ul class=\"list talents\">";
	counter = 0;
	var talentsData = [];
	for (var i = 0, len = TALENTS.length; i < len; i++) if(cV.talentInfo[ TALENTS[i].obj.id ]) talentsData.push([ TALENTS[i].obj.id,TALENTS[i],cV.talentInfo[ TALENTS[i].obj.id ].row ]);
	talentsData.sort(function(a,b){ return a[2] < b[2] ? - 1 : 1 });
	for (var i = 0, len = talentsData.length; i < len; i++) {
		var talentData = talentsData[i][1].obj

		if(counter % 3 == 0) HTML += "<li class=\"item clearfix\">";
		
		HTML += "<div class=\"row w33\"><div class=\"col w70p\">";
		HTML += "<a href=\"//www.wowhead.com/spell="+talentData.id+"\" target=\"_blank\"><img src=\"http://media.blizzard.com/wow/icons/56/"+cV.talentInfo[ talentData.id ].icon+"\" alt=\""+talentData.name+"\"></a></div>";

		HTML += "<div class=\"col div_more_1 w80\"><header><a href=\"//www.wowhead.com/spell="+talentData.id+"\" target=\"_blank\">"+talentData.name+"</a></header>";
	
		var amount = rV.talents[talentData.id]
		HTML += "<em class=\"result\">"+NumberToFormattedNumber(amount,2)+"</em> ("+(amount/rV.total*100).toFixed(2)+"%)<br>";
		HTML += "HPS: <em class=\"result-hps\">"+NumberToFormattedNumber(amount / fightLen * 1000,1)+"</em>";

		if(talentData.additionalText) HTML += "<br>"+talentData.additionalText();
	
		HTML += "</div></div>";
		counter++;
	}	
	HTML += "</ul></div></div></div>";
		
	
	
	/// Resurgence
	HTML += "<div class=\"panel\"><div class=\"col-full\"><div class=\"box\"><header class=\"box-header\">RESURGENCE</header><div class=\"list-top-line\"> </div><ul class=\"list resurgence\">";
	counter = 0;
	var resurgenceData = [];
	for (var i = 0, len = RESURGENCE.length; i < len; i++) if(rV.resurgence[ RESURGENCE[i].obj.id ][0] > 0) resurgenceData.push([ RESURGENCE[i].obj.id,RESURGENCE[i] ]);
	resurgenceData.sort(function(a,b){ return rV.resurgence[ a[0] ][0] > rV.resurgence[ b[0] ][0] ? - 1 : 1 });
	for (var i = 0, len = resurgenceData.length; i < len; i++) {
		var obj = resurgenceData[i][1].obj

		if(counter % 3 == 0) HTML += "<li class=\"item clearfix\">";
		
		HTML += "<div class=\"row w33\"><div class=\"col w70p\">";
		HTML += "<a href=\"//www.wowhead.com/spell="+obj.id+"\" target=\"_blank\"><img src=\"http://media.blizzard.com/wow/icons/56/"+obj.icon+"\" alt=\""+obj.name+"\"></a></div>";

		HTML += "<div class=\"col div_more_1 w80\"><header><a href=\"//www.wowhead.com/spell="+obj.id+"\" target=\"_blank\">"+obj.name+"</a></header>";
	
		var amount = rV.resurgence[obj.id][0];
		HTML += "Mana gained: <em class=\"result\">"+NumberToFormattedNumber(amount,0,2)+"</em> ("+(amount/rV.manaUsage*100).toFixed(2)+"%)<br>";
		HTML += "Count: "+rV.resurgence[obj.id][1];
	
		HTML += "</div></div>";
		counter++;
	}	
	HTML += "</ul></div></div></div>";
	
	
	/// Potions
	HTML += "<div class=\"panel\"><div class=\"col-full\"><div class=\"box\"><header class=\"box-header\">POTIONS</header><div class=\"list-top-line\"> </div><ul class=\"list potions\">";
	counter = 0;
	for (var i = 0, len = POTIONS.length; i < len; i++) {
		var potionData = POTIONS[i].obj
		if(rV.potions[potionData.id] > 0){
			if(counter % 3 == 0) HTML += "<li class=\"item clearfix\">";
			
			HTML += "<div class=\"row w33\"><div class=\"col w70p\">";
			HTML += "<a href=\"//www.wowhead.com/spell="+potionData.id+"\" target=\"_blank\"><img src=\"http://media.blizzard.com/wow/icons/56/"+potionData.icon+"\" alt=\""+potionData.name+"\"></a></div>";
	
			HTML += "<div class=\"col div_more_1 w80\"><header><a href=\"//www.wowhead.com/spell="+potionData.id+"\" target=\"_blank\">"+potionData.name+"</a></header>";
		
			if(!potionData.text){
				var amount = rV.potions[potionData.id]
				HTML += "<em class=\"result\">"+NumberToFormattedNumber(amount,0,2)+"</em> ("+(amount/rV.total*100).toFixed(2)+"%)<br>";
				HTML += "HPS: <em class=\"result-hps\">"+NumberToFormattedNumber(amount / fightLen * 1000,1)+"</em>";
			} else {
				HTML += potionData.text();
			}
		
			HTML += "</div></div>";
			counter++;
		}
	}	
	HTML += "</ul></div></div></div>";
	
	
	/// Procs
	HTML += "<div class=\"panel\"><div class=\"col-full\"><div class=\"box clearfix procs\"><header class=\"box-header\">PROCS</header><div class=\"list-top-line\" style=\"margin-bottom:10px;\"> </div>";
	counter = 0;
	var procsData = [];
	Object.keys(rV.buffs).forEach(function (statName) {
		Object.keys(rV.buffs[statName]).forEach(function (spellID) {
			if(spellID > 0){
				var key = -1;
				for (var i = 0, len = procsData.length; i < len; i++){
					if(procsData[i][0] == spellID){
						key = i;
						break
					}
				}
				if(key == -1) {
					procsData.push([spellID,0,[]]);
					key = procsData.length - 1;
				}
				procsData[key][1] += rV.buffs[statName][spellID];
				procsData[key][2].push((statName=="haste_mod" ? "haste" : statName)+": "+NumberToFormattedNumber(rV.buffs[statName][spellID],0,2));
			}
		});
	});
	procsData.sort(function(a,b){ return a[1] > b[1] ? - 1 : 1 });
	for (var i = 0, len = procsData.length; i < len; i++) {
		var spellID = procsData[i][0];
		var icon = cV.spellInfo[spellID] ? cV.spellInfo[spellID].icon : "";
		var name = cV.spellInfo[spellID] ? cV.spellInfo[spellID].name : "";
		HTML += "<div class=\"row half\"><div class=\"col w40\"><a href=\"//www.wowhead.com/spell="+spellID+"\" target=\"_blank\"><img src=\"http://media.blizzard.com/wow/icons/56/"+icon+"\" alt=\""+name+"\"> "+name+"</a></div><div class=\"col w30\"><em class=\"tooltip\">"+NumberToFormattedNumber(procsData[i][1],0,2)+"<span class=\"tip-text\" style=\"width: 120px;margin-left:-60px;\">"+procsData[i][2].join("<br>")+"</span></em></div><div class=\"col w30\">"+(procsData[i][1]/rV.total*100).toFixed(2)+"%</div></div>";
	}
	HTML += "</div></div></div>";
	
	
	/// Mastery
	HTML += "<div class=\"panel\"><div class=\"col-full\"><div class=\"box clearfix mastery_eff\"><header class=\"box-header\">MASTERY</header>";
	counter = 0;
	var masteryUnitsData = [];
	var masteryAVGMax;
	var masteryAmountTotal = 0;
	var masteryAmountTotal2 = 0;
	var masteryAmountMax;
	var masteryTmp1 = 0;
	Object.keys(healPerStat.mastery.t).forEach(function (unitID) {
		if(healPerStat.mastery.t[unitID].amount > 0 && actorsData[unitID] && actorsData[unitID].class && classes[ actorsData[unitID].class ]){
			healPerStat.mastery.t[unitID].avg = healPerStat.mastery.t[unitID].hp / healPerStat.mastery.t[unitID].amount;
			if(!masteryAVGMax || masteryAVGMax < healPerStat.mastery.t[unitID].avg)	masteryAVGMax = healPerStat.mastery.t[unitID].avg;
			masteryUnitsData.push(unitID);
			masteryAmountTotal2 += healPerStat.mastery.t[unitID].amount;
			masteryAmountTotal += healPerStat.mastery.t[unitID].mamount;
			if(!masteryAmountMax || masteryAmountMax < healPerStat.mastery.t[unitID].mamount) masteryAmountMax = healPerStat.mastery.t[unitID].mamount;
		}
	});
	HTML += "<div class=\"row full\"><div class=\"col w20\"></div><div class=\"col w5\"></div><div class=\"col w30\">Mastery effectiveness</div><div class=\"col w5\"></div><div class=\"col w30\"><em class=\"tooltip\">Healing done to target<span class=\"tip-text\" style=\"width: 300px;margin-left:-150px;\">Only healing coming from mastery used here</span></em></div></div>";
	masteryUnitsData.sort(function(a,b){ return healPerStat.mastery.t[a].avg > healPerStat.mastery.t[b].avg ? - 1 : 1 });
	for (var i = 0, len = masteryUnitsData.length; i < len; i++) {
		var unitID = masteryUnitsData[i];
		var unitData = actorsData[unitID];
		var avg = 1 - healPerStat.mastery.t[unitID].avg;
		HTML += "<div class=\"row full\"><div class=\"col w5\"></div><div class=\"col w15\">"+unitData.name+"</div>";
		
		//HTML += "<div class=\"col w10 t-right\"><em class=\"tooltip\">"+((1 - avg)*100).toFixed(2)+"%<span class=\"tip-text\" style=\"width: 300px;margin-left:-150px;\">Mastery effectiveness:"+((1 - avg)*100).toFixed(2)+"%<br>Target avg health:"+(avg*100).toFixed(2)+"%<br>Maximum mastery effectiveness:"+(healPerStat.mastery.t[unitID].max * 100).toFixed(2)+"%</span></em></div>";
		HTML += "<div class=\"col w10 t-right\"><em class=\"tooltip\">"+((1 - avg)*100).toFixed(2)+"%<span class=\"tip-text\" style=\"width: 300px;margin-left:-150px;\">Mastery effectiveness:"+((1 - avg)*100).toFixed(2)+"%<br>Target avg health:"+(avg*100).toFixed(2)+"%</span></em></div>";
		
		var width = healPerStat.mastery.t[unitID].avg / masteryAVGMax;
		HTML += "<div class=\"col w25 clearfix\"><div class=\"performance-bar "+actorsData[unitID].class+"-bg\" style=\"width: "+(width * 100).toFixed(2)+"%;\"></div></div>";
		var amount = healPerStat.mastery.t[unitID].mamount / masteryAmountTotal;
		HTML += "<div class=\"col w10 t-right\">"+(amount*100).toFixed(2)+"%</div>";
		var amountWidth = healPerStat.mastery.t[unitID].mamount / masteryAmountMax;
		HTML += "<div class=\"col w25 clearfix\"><div class=\"performance-bar "+actorsData[unitID].class+"-bg\" style=\"width: "+(amountWidth * 100).toFixed(2)+"%;\"></div></div>";
		
		var spells = Object.keys(healPerStat.mastery.t[unitID].spells)
		spells.sort(function(a,b){ return healPerStat.mastery.t[unitID].spells[a] > healPerStat.mastery.t[unitID].spells[b] ? - 1 : 1 });
		var subSpellsList = "";
		for (var k = 0, k_len = spells.length; k < k_len; k++) {
			var spellID = spells[k]
			var icon = cV.spellInfo[spellID] ? cV.spellInfo[spellID].icon : "";
			var name = cV.spellInfo[spellID] ? cV.spellInfo[spellID].name : "";
			subSpellsList += "<img src=\"http://media.blizzard.com/wow/icons/56/"+icon+"\" alt=\""+name+"\"> "+name+" - "+NumberToFormattedNumber(healPerStat.mastery.t[unitID].spells[spellID],0,2)+"<br>";

		}
		
		//masteryTmp1 += (1 - avg) * amount;
		masteryTmp1 += (1 - avg) * (healPerStat.mastery.t[unitID].amount / masteryAmountTotal2);
		
		
		HTML += "<div class=\"col w10\"><em class=\"tooltip\">"+NumberToFormattedNumber(healPerStat.mastery.t[unitID].mamount,0,2)+"<span class=\"tip-text\" style=\"width: 300px;margin-left:-150px;\">"+subSpellsList+"</span></em></div>";
		HTML += "<div class=\"list-top-line\"></div>";
		HTML += "</div>";
	}
	HTML += "<div class=\"row full\"><div class=\"col w5\"></div><div class=\"col w20\">Average mastery effectiveness</div><div class=\"col w5 t-right\">"+(masteryTmp1*100).toFixed(2)+"%</div><div class=\"col w25 clearfix\"><div class=\"performance-bar\" style=\"width: "+(Math.min(masteryTmp1/masteryAVGMax,1) * 100).toFixed(2)+"%;\"></div></div><div class=\"list-top-line\"></div></div>";
	HTML += "</div></div></div>";

	
	
	/// COOLDOWNS
	HTML += "<div class=\"panel\"><div class=\"col-full\"><div class=\"box\"><header class=\"box-header\">COOLDOWN USAGES</header><div class=\"list-top-line\"> </div><ul class=\"list cooldowns\">";
	for (var i = 0, len = cooldownsTracking.length; i < len; i++) {
		var obj = cooldownsTracking[i]
		var spellID = obj.spellID;
				
		HTML += "<li class=\"item clearfix\"><div class=\"row full\"><div class=\"col w70p\">";
		HTML += "<a href=\"//www.wowhead.com/spell="+spellID+"\"><img src=\"http://media.blizzard.com/wow/icons/56/"+cV.spellInfo[spellID].icon+"\" alt=\""+cV.spellInfo[spellID].name+"\"></a></div>";
	
		HTML += "<div class=\"col half\">";
		HTML += "<header class=\"cd_header\"><a href=\"//www.wowhead.com/spell="+spellID+"\">"+cV.spellInfo[spellID].name+"</a> ("+MsToFormattedTime(obj.start - fightStart)+" -> "+MsToFormattedTime((obj.ended || fightEnd) - fightStart)+"):</header>";

		HTML += "<div class=\"col full div_more_1\">";
		for (var j = 0, j_len = obj.spells.length; j < j_len; j++) {
			var j_spellID = obj.spells[j].spell;
			HTML += "<a href=\"//www.wowhead.com/spell="+j_spellID+"\" target=\"_blank\"><img src=\"http://media.blizzard.com/wow/icons/56/"+cV.spellInfo[j_spellID].icon+"\" alt=\""+cV.spellInfo[j_spellID].name+"\"></a>";
			
		}
		HTML += "<br><a href=\"javascript:void(0)\" class=\"more_1\">more</a></div>";

		HTML += "<div class=\"col full div_more_2\" style=\"display:none;\">";
		for (var j = 0, j_len = obj.spells.length; j < j_len; j++) {
			var j_spellID = obj.spells[j].spell;
			HTML += "<div class=\"row full\"><div class=\"cd_more_2_time\">"+(obj.spells[j].time / 1000).toFixed(3)+"</div><div class=\"cd_more_2_info\">";
			HTML += "<a href=\"//www.wowhead.com/spell="+j_spellID+"\" target=\"_blank\"><img src=\"http://media.blizzard.com/wow/icons/56/"+cV.spellInfo[j_spellID].icon+"\" alt=\""+cV.spellInfo[j_spellID].name+"\"> "+cV.spellInfo[j_spellID].name+"</a></div></div>";
		}
		HTML += "<br><a href=\"https://www.warcraftlogs.com/reports/"+reportFightCode+"#fight="+currFightData.id+"&type=healing&source="+currFightData.actor+"&start="+obj.start+"&end="+(obj.ended || fightEnd)+"\" target=\"_blank\">WCL link</a>";
		HTML += "<br><a href=\"javascript:void(0)\" class=\"more_2\">even more</a></div>";
		
		HTML += "<div class=\"col full div_more_3\" style=\"display:none;\">";
		
		var cooldownData_healingMore_pos = 0;
		var overHeal = 0;
		//var devSpellsCount = {};
		for (var j = 0, j_len = obj.spells.length; j < j_len; j++) {
			var j_spellID = obj.spells[j].spell;
			HTML += "<div class=\"row full\"><div class=\"cd_more_3_time\">"+(obj.spells[j].time / 1000).toFixed(3)+"</div><div class=\"cd_more_3_info\">";
			HTML += "<a href=\"//www.wowhead.com/spell="+j_spellID+"\" target=\"_blank\"><img src=\"http://media.blizzard.com/wow/icons/56/"+cV.spellInfo[j_spellID].icon+"\" alt=\""+cV.spellInfo[j_spellID].name+"\"> "+cV.spellInfo[j_spellID].name+"</a></div></div>";
		
			var timeLimit = obj.spells[j+1] ? obj.spells[j+1].time : fightEnd;
			for (var k = cooldownData_healingMore_pos, k_len = obj.heal.length; k < k_len; k++) {
				if(obj.heal[k].time >= timeLimit) break;
				var healObj = obj.heal[k]
				
				HTML += "<div class=\"row full\"><div class=\"cd_more_3_time\">"+(healObj.time / 1000).toFixed(3)+"</div><div class=\"cd_more_3_info cd_more_3_info_heal\">";
				HTML += "<a href=\"//www.wowhead.com/spell="+healObj.id+"\" target=\"_blank\"><img src=\"http://media.blizzard.com/wow/icons/56/"+cV.spellInfo[healObj.id].icon+"\" alt=\""+cV.spellInfo[healObj.id].name+"\"> "+cV.spellInfo[healObj.id].name+"</a> x"+healObj.count;
				HTML += "</div><div class=\"cd_more_3_info cd_more_3_info_amount\">"+healObj.amount.format()+"</div><div class=\"cd_more_3_info cd_more_3_info_over\">"+healObj.over.format()+"</div></div>";				
				
				overHeal += healObj.over;
				
				//if(!devSpellsCount[healObj.id]) devSpellsCount[healObj.id] = 0;devSpellsCount[healObj.id] += healObj.amount;
				
				cooldownData_healingMore_pos = k + 1;
			}
		}
		//console.log(cV.spellInfo[spellID].name,MsToFormattedTime(obj.start - fightStart),devSpellsCount);
		HTML += "<br><a href=\"https://www.warcraftlogs.com/reports/"+reportFightCode+"#fight="+currFightData.id+"&type=healing&source="+currFightData.actor+"&start="+obj.start+"&end="+(obj.ended || fightEnd)+"\" target=\"_blank\">WCL link</a>";
		HTML += "<br><a href=\"javascript:void(0)\" class=\"more_3\">hide</a></div></div>";

		
		HTML += "<div class=\"col text-center w13\"><div style=\"font-size: 2em;\">"+NumberToFormattedNumber(obj.healing,2)+"</div>HPS: "+NumberToFormattedNumber(obj.healing / ((obj.ended ? obj.ended : fightEnd) - obj.start) * 1000,2)+"</div>";
		HTML += "<div class=\"col text-center w13\"><div style=\"font-size: 2em;\">"+(overHeal / (obj.healing + overHeal) * 100).toFixed(2)+"%</div>overhealing</div>";
		HTML += "<div class=\"col text-center w13\"><div style=\"font-size: 2em;\">"+NumberToFormattedNumber(obj.mana)+"</div>Mana</div></div></li>";
	}
	HTML += "</ul></div></div></div>";
	
	
	/// SLT
	HTML += "<div class=\"panel\"><div class=\"col-full\"><div class=\"box\"><header class=\"box-header\">SPIRIT LINK</header><div class=\"list-top-line\"> </div><ul class=\"list slt\">";
	for (var i = 0, len = sltTracking.length; i < len; i++) {
		var obj = sltTracking[i]
		var spellID = 98021;
				
		HTML += "<li class=\"item clearfix\"><div class=\"row full\"><div class=\"col w70p\">";
		HTML += "<a href=\"//www.wowhead.com/spell="+spellID+"\"><img src=\"http://media.blizzard.com/wow/icons/56/"+cV.spellInfo[spellID].icon+"\" alt=\""+cV.spellInfo[spellID].name+"\"></a></div>";
	
		HTML += "<div class=\"col half\">";
		HTML += "<header class=\"cd_header\"><a href=\"//www.wowhead.com/spell="+spellID+"\">"+cV.spellInfo[spellID].name+"</a> ("+MsToFormattedTime(obj.start - fightStart)+" -> "+MsToFormattedTime((obj.ended ? obj.ended : fightEnd) - fightStart)+"):</header>";

		HTML += "<div class=\"col full div_more_2\"><a href=\"javascript:void(0)\" class=\"more_2\">expand</a></div>";
		
		HTML += "<div class=\"col full div_more_3\" style=\"display:none;\">";
		
		var TotalHealing = 0;
		var cooldownData_healingMore_pos = 0;
		var prevTime = -1;
		for (var j = 0, j_len = obj.damage.length; j < j_len; j++) {
			Object.keys(obj.damage[j].data).forEach(function (unitID) {
				var unitData = actorsData[unitID];
				if(unitData){
					HTML += "<div class=\"row full\"><div class=\"cd_more_3_time\">"+(prevTime < obj.damage[j].time ? (obj.damage[j].time / 1000).toFixed(3) : "")+"</div><div class=\"cd_more_3_info cd_more_3_info_heal"+(unitData.class ? (" "+unitData.class) : "")+"\">";
					HTML += unitData.name+"</div><div class=\"cd_more_3_info cd_more_3_info_amount slt-damage\">"+obj.damage[j].data[unitID].amount.format()+"</div>";
					if(obj.damage[j].data[unitID].absorbed > 0) HTML += "<div class=\"cd_more_3_info cd_more_3_info_over\">"+obj.damage[j].data[unitID].absorbed.format()+"</div>";
					HTML += "</div>";
					prevTime = obj.damage[j].time;
				}
			});
		
			var timeLimit = obj.damage[j+1] ? obj.damage[j+1].time : fightEnd;
			for (var k = cooldownData_healingMore_pos, k_len = obj.heal.length; k < k_len; k++) {
				if(obj.heal[k].time >= timeLimit) break;
				Object.keys(obj.heal[k].data).forEach(function (unitID) {
					var unitData = actorsData[unitID];
					if(unitData){
						HTML += "<div class=\"row full\"><div class=\"cd_more_3_time\">"+(prevTime < obj.heal[k].time ? (obj.heal[k].time / 1000).toFixed(3) : "")+"</div><div class=\"cd_more_3_info cd_more_3_info_heal"+(unitData.class ? (" "+unitData.class) : "")+"\">";
						HTML += unitData.name+"</div><div class=\"cd_more_3_info cd_more_3_info_amount slt-heal\">"+obj.heal[k].data[unitID].amount.format()+"</div>";
						if(obj.heal[k].data[unitID].absorbed > 0) HTML += "<div class=\"cd_more_3_info cd_more_3_info_over\">"+obj.heal[k].data[unitID].absorbed.format()+"</div>";
						HTML += "</div>";
						prevTime = obj.heal[k].time;
						TotalHealing += obj.heal[k].data[unitID].amount;
					}
				});
				
				cooldownData_healingMore_pos = k + 1;
			}
		}
		HTML += "<br><a href=\"javascript:void(0)\" class=\"more_3-2\">hide</a></div></div>";
		
		HTML += "<div class=\"col text-center w20\"><div style=\"font-size: 2em;\">"+NumberToFormattedNumber(TotalHealing,2)+"</div>HPS: "+NumberToFormattedNumber(TotalHealing / ((obj.ended ? obj.ended : fightEnd) - obj.start) * 1000,2)+"</div></div></li>";
	}
	HTML += "</ul></div></div></div>";


	$("#main").html(HTML);

	$("a.more_1").click(function(){$(this).parent().hide();$(this).parent().parent().find(".div_more_2").show();return false;});
	$("a.more_2").click(function(){$(this).parent().hide();$(this).parent().parent().find(".div_more_3").show();return false;});
	$("a.more_3").click(function(){$(this).parent().hide();$(this).parent().parent().find(".div_more_1").show();return false;});
	$("a.more_3-2").click(function(){$(this).parent().hide();$(this).parent().parent().find(".div_more_2").show();return false;});

	
	for (var i = 0, len = UpdateFromWowhead.length; i < len; i++) {
		GetItemDataFromWowhead(UpdateFromWowhead[i]);
	}

	$("a.more_graph").click(function(){
		var statsList = ["int","haste","mastery","vers","crit"];
		var statsListNames = ["Int","Haste","Mastery","Vers","Crit (w/o resurgence)"];
		var graphLabels = [];
		var graphSeries = [];
		for (var k = 0, k_len = statsList.length; k < k_len; k++) graphSeries.push([]);
		for (var j = 0, j_len = (fightLen / 1000 / STATS_GRAPH_STEP); j < j_len; j++) {
			if(healPerStat.graph[j]){
				graphLabels.push(MsToFormattedTime(j * 1000 * STATS_GRAPH_STEP));
				
				for (var k = 0, k_len = statsList.length; k < k_len; k++) {
					graphSeries[k].push(healPerStat.graph[j][ statsList[k] ].amount);
				}
			}
		}
		
		var x_d = Math.floor(fightLen / 1000 / 20 / STATS_GRAPH_STEP) + 1;
		
		new Chartist.Line('.ct-chart', { labels: graphLabels, series: graphSeries}, {
			fullWidth: true,
			height: 200,
			//showArea: true,
			showPoint: false,
			lineSmooth: Chartist.Interpolation.cardinal({tension: 0.65}),
			axisX: {
				labelInterpolationFnc: function(value, index) {
					return (index % x_d) == 0 ? value : null;
				}
			},
			plugins: [
				Chartist.plugins.legend({legendNames: statsListNames})
			]
		});	
	
		$("#stats_graph_more").hide();
		$("#stats_graph").show();
		return false;
	});
	

	
}

function BuildFightsList(){
	var HTML = "";
	HTML += "<div class=\"panel\"><div class=\"col-full\"><div class=\"box\"><ul class=\"list fightslist\">";
	
	var WCLFightCounter = {};
	Object.keys(fightsData).forEach(function (fightID) {
		var obj = fightsData[fightID];
		if(obj.actors && obj.boss && diffIdToName[obj.difficulty]){
			WCLFightCounter[obj.boss] = WCLFightCounter[obj.boss] || {}
			WCLFightCounter[obj.boss][obj.difficulty] = (WCLFightCounter[obj.boss][obj.difficulty] || 0) + 1
			for (var j = 0, j_len = obj.actors.length; j < j_len; j++) {
				if(actorsData[ obj.actors[j] ].class == "Shaman"){
					HTML += "<a href=\"?report="+reportFightCode+"&fight="+fightID+"&actor="+obj.actors[j]+"\" data-fight=\""+fightID+"\" data-actor=\""+obj.actors[j]+"\" class=\"fightlist-btn\">";
					HTML += "<li class=\"item clearfix\" style=\"padding: 5px 15px;\"><div class=\"row full\"><div class=\"col\" style=\"width:30%\">";
					HTML += diffIdToName[obj.difficulty]+" "+obj.name+" "+(!obj.kill ? "#"+WCLFightCounter[obj.boss][obj.difficulty] : "")+" <em class=\""+(obj.kill ? "kill" : "wipe")+"\">"+(obj.kill ? "kill" : "wipe")+"</em></div>";
					HTML += "<div class=\"col\" style=\"width:5%\">"+MsToFormattedTime(obj.end_time - obj.start_time)+"</div><div class=\"col\" style=\"width:20%\">"+actorsData[ obj.actors[j] ].name+"</div></div>";
					HTML += "</li></a>";
				}
			}
		}		
	});
	
	HTML += "</ul></div></div></div>";
	
	$("#main").html(HTML);
	
	$(".fightlist-btn").click(function(e){
		e.preventDefault();
		var fightID = $(this).attr("data-fight");
		var obj = fightsData[fightID];
		if(obj){
			var actorID = $(this).attr("data-actor");
			
			PrepParse(fightID, actorID);
		}
	});
	
	var HTML = "";
	HTML += "<li class=\"breadcrumb-item\"><a href=\"?\" id=\"nav-btn-main\">Resto Analyzer</a></li>";
	HTML += "<li class=\"breadcrumb-item\"><a href=\"https://www.warcraftlogs.com/reports/"+reportFightCode+"\" target=\"_blank\">Report</a></li>";
	$("#navbar-header").html(HTML);
	
	$("#nav-btn-main").click(function(e){ e.preventDefault(); BuildMainPage(); });
	
	$("#navbar-progress").width("0%").css('opacity', '0');
	
	window.history.pushState('report', 'Report', '?report='+reportFightCode);
}

function CreateHealPerStatTable(){
	return {
		int: {amount:0,total:0,avg:0,avgCount:0,all:0},
		crit: {amount:0,total:0,avg:0,avgCount:0,all:0},
		haste: {amount:0,total:0,avg:0,avgCount:0,all:0},
		mastery: {amount:0,total:0,avg:0,avgCount:0,all:0,b100:0,b80:0,b70:0,b60:0,b50:0,b40:0,b30:0,t:{}},
		vers: {amount:0,total:0,avg:0,avgCount:0,all:0},	
	}
}

function PrepParse(fightID,actorID){
	$("#navbar-progress").width("1%").css('opacity', '1');
	
	var obj = fightsData[fightID];
	
	currFightData.start_time = obj.start_time;
	currFightData.end_time = obj.end_time;
	currFightData.actor = actorID;
	currFightData.id = fightID;
	currFightData.name = diffIdToName[obj.difficulty]+" "+obj.name+(obj.kill ? " - Kill" : "");
	currFightData.actorName = actorsData[actorID].name;
	currFightData.len = obj.end_time - obj.start_time;
	
	//erase variables 
	actors = [];
	healingData = [];
	pV = {},
	rV = {
		talents: [],
		traits: [],
		resurgence: [],
		potions: [],
		buffs: {
			vers: [],
			crit: [],
			haste: [],
			haste_mod: [],
			mastery: [],
			int: [],	
		},
		healFromMana: 0,
		manaUsage: 0,
		manaUsageBySpell: [],
		manaGain: 0,
		netherlight: [],
	};
	cV = {
		traitInfo: [],
		traitBySpell: [],
		gearInfo: [],
		talentInfo: [],
		spellInfo: [],
	};
	healPerStat = CreateHealPerStatTable();
	healPerStat.graph = [];
	cooldownsTracking = [];
	sltTracking = [];
	buffStatus = [];
	
	for (var k = 0, k_len = pluginsList.length; k < k_len; k++) {
		var pluginData = pluginsList[k];
		for (var i = 0, len = pluginData.length; i < len; i++) if(pluginData[i].init) pluginData[i].init();
	}
	
	var HTML = "";
	HTML += "<li class=\"breadcrumb-item\"><a href=\"?\" id=\"nav-btn-main\">Resto Analyzer</a></li>";
	HTML += "<li class=\"breadcrumb-item\"><a href=\"?report="+reportFightCode+"\" id=\"nav-btn-fights\">"+currFightData.report_name+"</a></li>";
	HTML += "<li class=\"breadcrumb-item\"><a href=\"https://www.warcraftlogs.com/reports/"+reportFightCode+"#fight="+currFightData.id+"&type=summary\" target=\"_blank\">"+currFightData.name+" ("+MsToFormattedTime(currFightData.end_time - currFightData.start_time)+")</a></li>";
	HTML += "<li class=\"breadcrumb-item\"><a href=\"https://www.warcraftlogs.com/reports/"+reportFightCode+"#fight="+currFightData.id+"&type=healing&source="+currFightData.actor+"\" target=\"_blank\">"+currFightData.actorName+"</a></li>";
	$("#navbar-header").html(HTML);

	$("#nav-btn-main").click(function(e){ e.preventDefault(); BuildMainPage(); });
	$("#nav-btn-fights").click(function(e){ e.preventDefault(); BuildFightsList(); });
	
	$("#main").html("");


	window.history.pushState('result', 'Result', '?report='+reportFightCode+'&fight='+fightID+'&actor='+actorID);

	ParseLog(reportFightCode,actorID,currFightData.start_time,currFightData.end_time);
}

function BuildMainPage(){
	var HTML = "";
	
	HTML += "<div class=\"panel half\" style=\"margin-right:auto;margin-left: auto;float:inherit;\"><div class=\"col-full\"><div class=\"box pos-center\" style=\"font-size: 14px;padding-left:20px;padding-bottom:20px\">";
	HTML += "<header class=\"box-header\">ANALYZE REPORT</header>";

	HTML += "<form id=\"mainpage-form\"><b>Enter your Warcraft Logs report code.</b><br>https://www.warcraftlogs.com/reports/ <input type=\"text\" id=\"mainpage-input\" size=\"20\" class=\"form-control\"> /<br>";
	HTML += "<input type=\"submit\" value=\"Analyze\" class=\"form-btn\" id=\"mainpage-btn\"></form></div></div></div>";

	$("#main").html(HTML);
	
	$("#mainpage-form").submit(function(e) {
		e.preventDefault();
	});
	
	$("#mainpage-btn").click(function(){
		reportFightCode = $("#mainpage-input").val();
		ParseHeader(reportFightCode,true);
	});
	
	var HTML = "";
	HTML += "<li class=\"breadcrumb-item\"><a href=\"?\" id=\"nav-btn-main\">Resto Analyzer</a></li>";
	$("#navbar-header").html(HTML);
	
	$("#nav-btn-main").click(function(e){ e.preventDefault(); BuildMainPage(); });
	
	window.history.pushState('main', 'Main', '?');
}

function QueryString() {
  // This function is anonymous, is executed immediately and 
  // the return value is assigned to QueryString!
  var query_string = {};
  var query = window.location.search.substring(1);
  var vars = query.split("&");
  for (var i=0;i<vars.length;i++) {
    var pair = vars[i].split("=");
        // If first entry with this name
    if (typeof query_string[pair[0]] === "undefined") {
      query_string[pair[0]] = decodeURIComponent(pair[1]);
        // If second entry with this name
    } else if (typeof query_string[pair[0]] === "string") {
      var arr = [ query_string[pair[0]],decodeURIComponent(pair[1]) ];
      query_string[pair[0]] = arr;
        // If third or later entry with this name
    } else {
      query_string[pair[0]].push(decodeURIComponent(pair[1]));
    }
  } 
  return query_string;
};

$(document).ready(function() {
	var get = QueryString();
	if(get.report && get.fight && get.actor){
		reportFightCode = get.report
		ParseHeader(reportFightCode,false,function(){ PrepParse(get.fight,get.actor); });
	} else if (get.report){
		reportFightCode = get.report
		ParseHeader(reportFightCode,true);
	} else {
		BuildMainPage();
	}
});